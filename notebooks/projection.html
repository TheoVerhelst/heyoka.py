<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Conserving first integrals via manifold projection &#8212; heyoka.py 3.2.0 documentation</title>
    
  <link rel="stylesheet" href="../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.c441f2ba0852f4cabcb80105e3a46ae6.css?v=5c8e4cc9" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.d3f166471bb80abb5163.js">

    <script src="../_static/documentation_options.js?v=4f6ddb47"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/sphinx-book-theme.7d483ff0a819d6edff12ce0b1ead3928.js?v=b56ca714"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Box control in satellite Formation Flying" href="Box%20control%20for%20Formation%20Flying%20Satellites.html" />
    <link rel="prev" title="Brouwer’s law in the outer Solar System" href="Outer%20Solar%20System.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  
  <h1 class="site-logo" id="site-title">heyoka.py 3.2.0 documentation</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <p class="caption collapsible-parent" role="heading">
 <span class="caption-text">
  Main
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../install.html">
   Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../changelog.html">
   Changelog
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../breaking_changes.html">
   Breaking changes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../benchmarks.html">
   Benchmarks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../acknowledgement.html">
   Acknowledgement
  </a>
 </li>
</ul>
<p class="caption collapsible-parent" role="heading">
 <span class="caption-text">
  Tutorials
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../basic_tutorials.html">
   Basic
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../tut_taylor_method.html">
     Taylor’s method
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20expression%20system.html">
     The expression system
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20adaptive%20integrator.html">
     The adaptive integrator
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Customising%20the%20adaptive%20integrator.html">
     Customising the adaptive integrator
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ODEs%20with%20parameters.html">
     ODEs with parameters
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Non-autonomous%20systems.html">
     Non-autonomous systems
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Dense%20output.html">
     Dense &amp; continuous output
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Event%20detection.html">
     Event detection
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../advanced_tutorials.html">
   Advanced
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="Batch%20mode%20overview.html">
     Batch mode
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ensemble_mode.html">
     Ensemble propagations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="parallel_mode.html">
     Parallel mode
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ext_precision.html">
     Computations in extended precision
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="arbitrary_precision.html">
     Computations in arbitrary precision
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="sympy_interop.html">
     Interoperability with SymPy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="compiled_functions.html">
     Compiled functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ex_system_revisited.html">
     Using the expression system effectively
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pickling.html">
     Pickle support
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="jit_caching.html">
     JIT compilation and caching
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
</ul>
<p class="caption collapsible-parent" role="heading">
 <span class="caption-text">
  Examples
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1 current active collapsible-parent">
  <a class="reference internal" href="../examples_astro.html">
   Celestial mechanics and astrodynamics
  </a>
  <ul class="current collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="The%20restricted%20three-body%20problem.html">
     The restricted three-body problem
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Periodic%20orbits%20in%20the%20CR3BP.html">
     Continuation of Periodic Orbits in the CR3BP
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Pseudo%20arc-length%20continuation%20in%20the%20CR3BP.html">
     Pseudo arc-length continuation in the CR3BP
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Long%20term%20stability%20of%20Trappist-1.html">
     Long term stability of N-body simulations: the case of Trappist-1
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Outer%20Solar%20System.html">
     Brouwer’s law in the outer Solar System
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Conserving first integrals via manifold projection
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Box%20control%20for%20Formation%20Flying%20Satellites.html">
     Box control in satellite Formation Flying
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Comparing%20coordinate%20systems.html">
     Comparing coordinate systems
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Inverting%20Kepler%27s%20equation%20in%20ODEs.html">
     Inverting Kepler’s equation in ODEs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Planetary%20embryos.html">
     Planetary embryos in the inner Solar System
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="mercury_precession.html">
     Mercury’s relativistic precession
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ttv.html">
     Calculating transit timing variations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="vsop2013.html">
     Introduction to the VSOP2013 planetary theory
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="elp2000.html">
     Introduction to the ELP2000 lunar theory
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="tides_spokes.html">
     Elastic tides
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="lagrangian_propagator.html">
     Lagrange propagation and the state transition matrix
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../examples_event.html">
   Event detection
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="Sampling%20events.html">
     Sampling events
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Poincar%C3%A9%20sections.html">
     Poincaré sections
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="second_integral.html">
     The second integral of motion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20Keplerian%20billiard.html">
     The Keplerian billiard
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20two-fixed%20elliptic%20billiard.html">
     The two-fixed centres elliptic billiard
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20wavy%20ramp.html">
     The wavy ramp
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20Maxwell-Boltzmann%20distribution.html">
     The Maxwell-Boltzmann distribution
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ev_sensitivity.html">
     Computing event sensitivity
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../examples_ml.html">
   Machine Learning
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="NeuralHamiltonianODEs.html">
     Neural Hamiltonian ODEs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="NeuralODEs.html">
     Neural ODEs
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../examples_others.html">
   Others
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="ensemble_batch_perf.html">
     Evaluating the performance of ensemble &amp; batch mode
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20variational%20equations.html">
     The variational equations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Optimal%20Control%20of%20the%20Lotka-Volterra%20equations.html">
     Optimal Control of the Lotka-Volterra equations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="definite_integrals.html">
     Computing definite integrals
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/notebooks/projection.ipynb.txt"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/bluescarni/heyoka.py"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/bluescarni/heyoka.py/issues/new?title=Issue%20on%20page%20%2Fnotebooks/projection.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>


            <!-- Full screen (wrap in <a> to have style consistency -->
            <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                    data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                    title="Fullscreen mode"><i
                        class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/bluescarni/heyoka.py/main?urlpath=lab/tree/doc/notebooks/projection.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i>
            Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setting-things-up">
   Setting things up
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fixing-the-energy">
   Fixing the energy
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#helping-the-optimiser-out">
   Helping the optimiser out
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#packaging-it-all-together">
   Packaging it all together
  </a>
 </li>
</ul>

        </nav>
        
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="conserving-first-integrals-via-manifold-projection">
<h1>Conserving first integrals via manifold projection<a class="headerlink" href="#conserving-first-integrals-via-manifold-projection" title="Link to this heading">¶</a></h1>
<p>As we saw in an <a class="reference internal" href="Outer%20Solar%20System.html"><span class="std std-doc">earlier example</span></a>, even though heyoka.py is not a <a class="reference external" href="https://en.wikipedia.org/wiki/Symplectic_integrator">symplectic integrator</a> it is nevertheless capable of optimally preserving conserved quantities in dynamical systems.</p>
<p>In order to conserve dynamical invariants, heyoka.py needs to be configured to operate at very low tolerances (i.e., below machine epsilon). High-precision numerical integrations however are computationally expensive, and in some contexts it is preferable, for performance reasons, to maintain a low integration accuracy while at the same time ensuring that the global dynamical invariants are preserved. This is the main reason why symplectic integrators are the tool of choice, for instance, in numerical studies of the long-term stability of extrasolar planetary systems.</p>
<p>In this example, we will show how we can enforce the conservation of dynamical invariants in high-tolerance numerical integrations with heyoka.py via a technique known as <em>manifold projection</em>.</p>
<section id="setting-things-up">
<h2>Setting things up<a class="headerlink" href="#setting-things-up" title="Link to this heading">¶</a></h2>
<p>We will re-use here the setup described in the <a class="reference internal" href="Outer%20Solar%20System.html"><span class="std std-doc">outer Solar System example</span></a>: a gravitational 6-body problem consisting of the Sun, Jupiter, Saturn, Uranus, Neptune and Pluto with realistic initial conditions.</p>
<p>Let us begin by defining a few constants and the initial conditions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">heyoka</span> <span class="k">as</span> <span class="nn">hy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Masses, from Sun to Pluto.</span>
<span class="n">masses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.00000597682</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">1047.355</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">3501.6</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">22869.</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">19314.</span><span class="p">,</span> <span class="mf">7.4074074e-09</span><span class="p">])</span>

<span class="c1"># The gravitational constant.</span>
<span class="n">G</span> <span class="o">=</span> <span class="mf">0.01720209895</span> <span class="o">*</span> <span class="mf">0.01720209895</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">365</span>

<span class="c1"># Initial conditions.</span>
<span class="n">ic</span> <span class="o">=</span> <span class="p">[</span><span class="c1"># Sun.</span>
      <span class="o">-</span><span class="mf">4.06428567034226e-3</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.08813756435987e-3</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.66162304225834e-6</span><span class="p">,</span> <span class="o">+</span><span class="mf">6.69048890636161e-6</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span>
      <span class="o">-</span><span class="mf">6.33922479583593e-6</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.13202145590767e-9</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span>
      <span class="c1"># Jupiter.</span>
      <span class="o">+</span><span class="mf">3.40546614227466e+0</span><span class="p">,</span> <span class="o">+</span><span class="mf">3.62978190075864e+0</span><span class="p">,</span> <span class="o">+</span><span class="mf">3.42386261766577e-2</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.59797969310664e-3</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span>
      <span class="o">+</span><span class="mf">5.51815399480116e-3</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.66711392865591e-6</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span>
      <span class="c1"># Saturn.</span>
      <span class="o">+</span><span class="mf">6.60801554403466e+0</span><span class="p">,</span> <span class="o">+</span><span class="mf">6.38084674585064e+0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.36145963724542e-1</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.17354020307064e-3</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span>
      <span class="o">+</span><span class="mf">3.99723751748116e-3</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span> <span class="o">+</span><span class="mf">1.67206320571441e-5</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span>
      <span class="c1"># Uranus.</span>
      <span class="o">+</span><span class="mf">1.11636331405597e+1</span><span class="p">,</span> <span class="o">+</span><span class="mf">1.60373479057256e+1</span><span class="p">,</span> <span class="o">+</span><span class="mf">3.61783279369958e-1</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.25884806151064e-3</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span>
      <span class="o">+</span><span class="mf">2.06438412905916e-3</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.17699042180559e-5</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span>
      <span class="c1"># Neptune.</span>
      <span class="o">-</span><span class="mf">3.01777243405203e+1</span><span class="p">,</span> <span class="o">+</span><span class="mf">1.91155314998064e+0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.53887595621042e-1</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.17471785045538e-4</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span>
      <span class="o">-</span><span class="mf">3.11361111025884e-3</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span> <span class="o">+</span><span class="mf">3.58344705491441e-5</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span>
      <span class="c1"># Pluto.</span>
      <span class="o">-</span><span class="mf">2.13858977531573e+1</span><span class="p">,</span> <span class="o">+</span><span class="mf">3.20719104739886e+1</span><span class="p">,</span> <span class="o">+</span><span class="mf">2.49245689556096e+0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.76936577252484e-3</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span>
      <span class="o">-</span><span class="mf">2.06720938381724e-3</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span> <span class="o">+</span><span class="mf">6.58091931493844e-4</span> <span class="o">*</span> <span class="mi">365</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>See the <a class="reference internal" href="Outer%20Solar%20System.html"><span class="std std-doc">outer Solar System example</span></a> for more details on the setup.</p>
<p>Next, we setup the dynamical equations of our N-body problem:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the ODEs.</span>
<span class="n">sys</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">nbody</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">masses</span> <span class="o">=</span> <span class="n">masses</span><span class="p">,</span> <span class="n">Gconst</span> <span class="o">=</span> <span class="n">G</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We also store the 36 state variables (3 Cartesian positions and 3 Cartesian velocities for each of the 6 bodies) in a list for later use:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">state_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sys</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we define a <a class="reference internal" href="compiled_functions.html"><span class="std std-doc">compiled function</span></a> for the rapid computation of the energy of the system from the state vector. Here we are using the <code class="docutils literal notranslate"><span class="pre">model.nbody_energy()</span></code> helper, which creates the symbolic formula for the energy constant in the N-body problem:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a compiled function for the computation</span>
<span class="c1"># of the energy in an N-body system from its state vector.</span>
<span class="n">en_cfunc</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">make_cfunc</span><span class="p">([</span><span class="n">hy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">nbody_energy</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">masses</span><span class="o">=</span><span class="n">masses</span><span class="p">,</span> <span class="n">Gconst</span><span class="o">=</span><span class="n">G</span><span class="p">)],</span>
                         <span class="nb">vars</span><span class="o">=</span><span class="n">state_vars</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can now proceed to the instantiation of the numerical integrator. We choose a high tolerance of <span class="math notranslate nohighlight">\(10^{-6}\)</span>, so that the integrator will not be able to enforce energy conservation on its own (since we are not operating at sub-epsilon tolerances):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ta</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">taylor_adaptive</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let us now compute the initial energy of the system:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial energy: </span><span class="si">{</span><span class="n">en_cfunc</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Initial energy: -0.004286848855986956
</pre></div>
</div>
</div>
</div>
<p>So far so good (though perhaps not very exciting).</p>
<p>The next step is the introduction of a callback to be invoked after every step taken by the numerical integrator. This callback will check the relative energy error, and stop the integration if the error exceeds the <span class="math notranslate nohighlight">\(10^{-6}\)</span> threshold:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">proj_callback</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ta</span><span class="p">):</span>
        <span class="c1"># Store the initial energy value</span>
        <span class="c1"># as a data member.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">E0</span> <span class="o">=</span> <span class="n">en_cfunc</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ta</span><span class="p">):</span>
        <span class="c1"># Compute the relative energy error</span>
        <span class="c1"># wrt the initial energy value.</span>
        <span class="n">rel_err</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">en_cfunc</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span>
        
        <span class="c1"># Stop if the error is greater than 1e-6.</span>
        <span class="k">if</span> <span class="n">rel_err</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rel energy error: </span><span class="si">{</span><span class="n">rel_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<p>Let us now integrate until the energy error reaches the threshold:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cb</span> <span class="o">=</span> <span class="n">proj_callback</span><span class="p">(</span><span class="n">ta</span><span class="p">)</span>
<span class="c1"># Attempt to propagate the state of the</span>
<span class="c1"># system for 1000 years.</span>
<span class="n">ta</span><span class="o">.</span><span class="n">propagate_until</span><span class="p">(</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">callback</span> <span class="o">=</span> <span class="n">cb</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Rel energy error: 1.1480506370240604e-06
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;taylor_outcome.cb_stop: -4294967301&gt;,
 0.7296940138544884,
 1.0583722519817735,
 36,
 None)
</pre></div>
</div>
</div>
</div>
<p>We can see from the output that indeed the integration was terminated earlier because of the callback (as indicated by the <code class="docutils literal notranslate"><span class="pre">taylor_outcome.cb_stop</span></code> outcome), and that the error threshold was exceeded after 36 steps.</p>
</section>
<section id="fixing-the-energy">
<h2>Fixing the energy<a class="headerlink" href="#fixing-the-energy" title="Link to this heading">¶</a></h2>
<p>We can now move to the interesting part, that is, enforcing energy conservation. The basic idea is to alter the current state vector of the system (whose energy has drifted away from the initial value) so that the energy of the updated state vector matches the initial energy of the system.</p>
<p>Because there are infinite points in phase space whose energy is equal to the initial value, we impose the additional constraint that the updated state vector should be as close as possible to the original one. In other words, we are projecting the position in phase space of the current state vector onto the hyper-surface (manifold) defined by the conservation of energy.</p>
<p>This projection process can be seen as a <a class="reference external" href="https://en.wikipedia.org/wiki/Constrained_optimization">constrained optimisation problem</a>: we want to minimise the distance from the original state vector subject to the constraint that the updated state vector must lie on the manifold defined by the conservation of energy.</p>
<p>Let us begin with the definition of the objective function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">objfun</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As mentioned above, here we are trying to minimise the distance (in phase space) between the original state vector (<code class="docutils literal notranslate"><span class="pre">ta.state</span></code>) and the updated state vector (<code class="docutils literal notranslate"><span class="pre">x</span></code>).</p>
<p>Next, we define the constraint:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cstr_fun</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">en_cfunc</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cb</span><span class="o">.</span><span class="n">E0</span>
</pre></div>
</div>
</div>
</div>
<p>This equality constraint is satisifed if <code class="docutils literal notranslate"><span class="pre">cstr_fun()</span></code> returns zero, that is, if the energy of the updated state vector (<code class="docutils literal notranslate"><span class="pre">x</span></code>) is equal to the initial energy of the system (stored in the callback as <code class="docutils literal notranslate"><span class="pre">cb.E0</span></code>).</p>
<p>We are now ready to run the optimisation via <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html#scipy.optimize.minimize" title="(in SciPy v1.11.4)"><code class="xref py py-func docutils literal notranslate"><span class="pre">scipy.optimize.minimize()</span></code></a>. Note that we need an optimiser with support for constraints (here we choose <code class="docutils literal notranslate"><span class="pre">'SLSQP'</span></code>):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">objfun</span><span class="p">,</span> <span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
               <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span>
               <span class="n">constraints</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;type&#39;</span> <span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span> <span class="p">:</span> <span class="n">cstr_fun</span><span class="p">}])</span>

<span class="c1"># Store the updated state vector.</span>
<span class="n">res</span><span class="o">=</span><span class="n">ret</span><span class="o">.</span><span class="n">x</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> message: Optimization terminated successfully
 success: True
  status: 0
     fun: 1.6028683862604742e-12
       x: [ 3.841e-04  4.208e-03 ... -1.215e+00  5.875e-02]
     nit: 2
     jac: [ 3.113e-08 -4.027e-07 ...  7.715e-11  7.409e-11]
    nfev: 76
    njev: 2
</pre></div>
</div>
</div>
</div>
<p>We can see how the optimisation terminated successfully.</p>
<p>Let us verify that the updated state vector (<code class="docutils literal notranslate"><span class="pre">res</span></code>) conserves energy with a better accuracy than the original state vector:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original energy error: </span><span class="si">{</span><span class="nb">abs</span><span class="p">((</span><span class="n">en_cfunc</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cb</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span><span class="o">/</span><span class="n">cb</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated  energy error: </span><span class="si">{</span><span class="nb">abs</span><span class="p">((</span><span class="n">en_cfunc</span><span class="p">(</span><span class="n">res</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cb</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span><span class="o">/</span><span class="n">cb</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Original energy error: 1.1480506370240604e-06
Updated  energy error: 1.3963053728083164e-11
</pre></div>
</div>
</div>
</div>
</section>
<section id="helping-the-optimiser-out">
<h2>Helping the optimiser out<a class="headerlink" href="#helping-the-optimiser-out" title="Link to this heading">¶</a></h2>
<p>Optimisation algorithms can greatly benefit from the availability of gradients for the objective function and the constraints. Luckily, heyoka.py’s expression system lets us compute derivatives without too much pain.</p>
<p>Let us begin by defining a symbolic expression representing the square of the distance between the original state vector and the updated state vector. Here, the original state vector will be represented by the symbolic state variables (stored earlier in <code class="docutils literal notranslate"><span class="pre">state_vars</span></code>) and the updated state vector will be passed in the array of <a class="reference internal" href="ODEs%20with%20parameters.html"><span class="std std-doc">runtime parameters</span></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dist2_ex</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">((</span><span class="n">state_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">hy</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">36</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>Let us take a look at <code class="docutils literal notranslate"><span class="pre">dist2_ex</span></code> just to fix the ideas:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dist2_ex</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>((vx_0 - p3)**2.0000000000000000 + (vx_1 - p9)**2.0000000000000000 + (vx_2 - p15)**2.0000000000000000 + (vx_3 - p21)**2.0000000000000000 + (vx_4 - p27)**2.0000000000000000 + (vx_5 - p33)**2.0000000000000000 + (vy_0 - p4)**2.0000000000000000 + (vy_1 - p10)**2.0000000000000000 + (vy_2 - p16)**2.0000000000000000 + (vy_3 - p22)**2.0000000000000000 + (vy_4 - p28)**2.0000000000000000 + (vy_5 - p34)**2.0000000000000000 + (vz_0 - p5)**2.0000000000000000 + (vz_1 - p11)**2.0000000000000000 + (vz_2 - p17)**2.0000000000000000 + (vz_3 - p23)**2.0000000000000000 + (vz_4 - p29)**2.0000000000000000 + (vz_5 - p35)**2.0000000000000000 + (x_0 - p0)**2.0000000000000000 + (x_1 - p6)**2.0000000000000000 + (x_2 - p12)**2.0000000000000000 + (x_3 - p18)**2.0000000000000000 + (x_4 - p24)**2.0000000000000000 + (x_5 - p30)**2.0000000000000000 + (y_0 - p1)**2.0000000000000000 + (y_1 - p7)**2.0000000000000000 + (y_2 - p13)**2.0000000000000000 + (y_3 - p19)**2.0000000000000000 + (y_4 - p25)**2.0000000000000000 + (y_5 - ...
</pre></div>
</div>
</div>
</div>
<p>We can now compute symbolically the gradient vector of <code class="docutils literal notranslate"><span class="pre">dist2_ex</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grad_dist2_ex</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dist2_ex</span><span class="p">,</span> <span class="n">state_vars</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">36</span><span class="p">))</span>
<span class="n">grad_dist2_ex</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[((2.0000000000000000 * x_0) - (2.0000000000000000 * p0)),
 ((2.0000000000000000 * y_0) - (2.0000000000000000 * p1)),
 ((2.0000000000000000 * z_0) - (2.0000000000000000 * p2)),
 ((2.0000000000000000 * vx_0) - (2.0000000000000000 * p3)),
 ((2.0000000000000000 * vy_0) - (2.0000000000000000 * p4)),
 ((2.0000000000000000 * vz_0) - (2.0000000000000000 * p5)),
 ((2.0000000000000000 * x_1) - (2.0000000000000000 * p6)),
 ((2.0000000000000000 * y_1) - (2.0000000000000000 * p7)),
 ((2.0000000000000000 * z_1) - (2.0000000000000000 * p8)),
 ((2.0000000000000000 * vx_1) - (2.0000000000000000 * p9)),
 ((2.0000000000000000 * vy_1) - (2.0000000000000000 * p10)),
 ((2.0000000000000000 * vz_1) - (2.0000000000000000 * p11)),
 ((2.0000000000000000 * x_2) - (2.0000000000000000 * p12)),
 ((2.0000000000000000 * y_2) - (2.0000000000000000 * p13)),
 ((2.0000000000000000 * z_2) - (2.0000000000000000 * p14)),
 ((2.0000000000000000 * vx_2) - (2.0000000000000000 * p15)),
 ((2.0000000000000000 * vy_2) - (2.0000000000000000 * p16)),
 ((2.0000000000000000 * vz_2) - (2.0000000000000000 * p17)),
 ((2.0000000000000000 * x_3) - (2.0000000000000000 * p18)),
 ((2.0000000000000000 * y_3) - (2.0000000000000000 * p19)),
 ((2.0000000000000000 * z_3) - (2.0000000000000000 * p20)),
 ((2.0000000000000000 * vx_3) - (2.0000000000000000 * p21)),
 ((2.0000000000000000 * vy_3) - (2.0000000000000000 * p22)),
 ((2.0000000000000000 * vz_3) - (2.0000000000000000 * p23)),
 ((2.0000000000000000 * x_4) - (2.0000000000000000 * p24)),
 ((2.0000000000000000 * y_4) - (2.0000000000000000 * p25)),
 ((2.0000000000000000 * z_4) - (2.0000000000000000 * p26)),
 ((2.0000000000000000 * vx_4) - (2.0000000000000000 * p27)),
 ((2.0000000000000000 * vy_4) - (2.0000000000000000 * p28)),
 ((2.0000000000000000 * vz_4) - (2.0000000000000000 * p29)),
 ((2.0000000000000000 * x_5) - (2.0000000000000000 * p30)),
 ((2.0000000000000000 * y_5) - (2.0000000000000000 * p31)),
 ((2.0000000000000000 * z_5) - (2.0000000000000000 * p32)),
 ((2.0000000000000000 * vx_5) - (2.0000000000000000 * p33)),
 ((2.0000000000000000 * vy_5) - (2.0000000000000000 * p34)),
 ((2.0000000000000000 * vz_5) - (2.0000000000000000 * p35))]
</pre></div>
</div>
</div>
</div>
<p>Shocking, I know.</p>
<p>We can now proceed to create a compiled function that will concatenate in a single vector output the value of the distance square and its gradient vector:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">objfun_cfunc</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">make_cfunc</span><span class="p">([</span><span class="n">dist2_ex</span><span class="p">]</span> <span class="o">+</span> <span class="n">grad_dist2_ex</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="n">state_vars</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we can define an updated objective function that, in addition to returning the distance square, will return also its gradient vector (in the format required by <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html#scipy.optimize.minimize" title="(in SciPy v1.11.4)"><code class="xref py py-func docutils literal notranslate"><span class="pre">scipy.optimize.minimize()</span></code></a>, i.e., as a tuple of 2 values):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">objfun</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">objfun_cfunc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pars</span><span class="o">=</span><span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
    
    <span class="c1"># Return the distance square and its</span>
    <span class="c1"># gradient as a tuple of 2 values.</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</pre></div>
</div>
</div>
</div>
<p>In a similar fashion, we can define a compiled function for the computation of the gradient of the constraint:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The symbolic expression representing the energy</span>
<span class="c1"># of the system.</span>
<span class="n">en_ex</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">nbody_energy</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">masses</span><span class="o">=</span><span class="n">masses</span><span class="p">,</span> <span class="n">Gconst</span><span class="o">=</span><span class="n">G</span><span class="p">)</span>

<span class="c1"># The gradient of the energy.</span>
<span class="n">grad_cstr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">en_ex</span><span class="p">,</span> <span class="n">state_vars</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">36</span><span class="p">))</span>

<span class="c1"># The compiled function for the computation of the gradient</span>
<span class="c1"># of the constraint.</span>
<span class="n">grad_cstr_cfunc</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">make_cfunc</span><span class="p">(</span><span class="n">grad_cstr</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="n">state_vars</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can now put everything together, and invoke again <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html#scipy.optimize.minimize" title="(in SciPy v1.11.4)"><code class="xref py py-func docutils literal notranslate"><span class="pre">scipy.optimize.minimize()</span></code></a> supplying the gradients:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">objfun</span><span class="p">,</span> <span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span>
               <span class="n">jac</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">constraints</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;type&#39;</span> <span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span> <span class="p">:</span> <span class="n">cstr_fun</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span> <span class="p">:</span> <span class="n">grad_cstr_cfunc</span><span class="p">}])</span>

<span class="n">res</span><span class="o">=</span><span class="n">ret</span><span class="o">.</span><span class="n">x</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> message: Optimization terminated successfully
 success: True
  status: 0
     fun: 1.6028685167358091e-12
       x: [ 3.841e-04  4.208e-03 ... -1.215e+00  5.875e-02]
     nit: 2
     jac: [ 3.120e-08 -4.048e-07 ...  2.930e-12 -1.417e-13]
    nfev: 4
    njev: 2
</pre></div>
</div>
</div>
</div>
<p>Like before, the optimisation completed successfully, this time taking far fewer objective function evaluations thanks to the availability of the gradient (which was previously estimated via numerical differencing).</p>
<p>We can again verify that the updated state vector (<code class="docutils literal notranslate"><span class="pre">res</span></code>) conserves energy with a better accuracy than the original state vector:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original energy error: </span><span class="si">{</span><span class="nb">abs</span><span class="p">((</span><span class="n">en_cfunc</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cb</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span><span class="o">/</span><span class="n">cb</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated  energy error: </span><span class="si">{</span><span class="nb">abs</span><span class="p">((</span><span class="n">en_cfunc</span><span class="p">(</span><span class="n">res</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cb</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span><span class="o">/</span><span class="n">cb</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Original energy error: 1.1480506370240604e-06
Updated  energy error: 1.3842666877172304e-11
</pre></div>
</div>
</div>
</div>
</section>
<section id="packaging-it-all-together">
<h2>Packaging it all together<a class="headerlink" href="#packaging-it-all-together" title="Link to this heading">¶</a></h2>
<p>As a last step, we now incorporate manifold projection into the step callback, so that we can automatically ensure energy conservation whenever the energy error drifts too far during the numerical integration.</p>
<p>Here is the updated version of the callback:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">proj_callback</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ta</span><span class="p">):</span>
        <span class="c1"># Store the initial energy value</span>
        <span class="c1"># as a data member.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">E0</span> <span class="o">=</span> <span class="n">en_cfunc</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Setup a variable to count how many times</span>
        <span class="c1"># we perform manifold projection.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_proj</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ta</span><span class="p">):</span>
        <span class="c1"># Compute the relative energy error</span>
        <span class="c1"># wrt the initial energy value.</span>
        <span class="n">rel_err</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">en_cfunc</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span>
        
        <span class="c1"># Fix the energy if the error is greater than 1e-6.</span>
        <span class="k">if</span> <span class="n">rel_err</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">objfun</span><span class="p">,</span> <span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span>
                           <span class="n">jac</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">constraints</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;type&#39;</span> <span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span> <span class="p">:</span> <span class="n">cstr_fun</span><span class="p">,</span>
                                         <span class="s1">&#39;jac&#39;</span> <span class="p">:</span> <span class="n">grad_cstr_cfunc</span><span class="p">}])</span>
            <span class="k">if</span> <span class="n">ret</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimisation returned nonzero status:</span><span class="se">\n</span><span class="si">{</span><span class="n">ret</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            
            <span class="c1"># Update the state vector.</span>
            <span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">x</span>
            
            <span class="c1"># Update the counter.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_proj</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<p>Let us now reset the state of the integrator back to the original initial conditions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ic</span>
<span class="n">ta</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="mf">0.</span>
</pre></div>
</div>
</div>
</div>
<p>We are now ready to repeat the numerical integration with automatic manifold projection. We will propagate the state of the system over an equispaced time grid up to <span class="math notranslate nohighlight">\(10^5\)</span> years:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create the callback object.</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">proj_callback</span><span class="p">(</span><span class="n">ta</span><span class="p">)</span>

<span class="c1"># Define the time grid.</span>
<span class="n">t_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="c1"># Run the numerical integration.</span>
<span class="n">pres_proj</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">propagate_grid</span><span class="p">(</span><span class="n">t_grid</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">cb</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let us also run a numerical integration without projection for comparison:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ic</span>
<span class="n">ta</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="mf">0.</span>

<span class="n">pres_noproj</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">propagate_grid</span><span class="p">(</span><span class="n">t_grid</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can now take a look at the results:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib.pylab</span> <span class="kn">import</span> <span class="n">plt</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Use log scale on the y axis.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

<span class="c1"># Compute the energy error over the time grid.</span>
<span class="n">err_proj_hist</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">cb</span><span class="o">.</span><span class="n">E0</span> <span class="o">-</span> <span class="n">en_cfunc</span><span class="p">(</span><span class="n">pres_proj</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">cb</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span>
<span class="n">err_noproj_hist</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">cb</span><span class="o">.</span><span class="n">E0</span> <span class="o">-</span> <span class="n">en_cfunc</span><span class="p">(</span><span class="n">pres_noproj</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">cb</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">,</span> <span class="n">err_proj_hist</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;With projection&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">,</span> <span class="n">err_noproj_hist</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Without projection&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (years)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Rel. energy error&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/65ae2579f32385dda9fb5fca839a870ce2f2e73660901f688d857c5fb99fcc4c.png" src="../_images/65ae2579f32385dda9fb5fca839a870ce2f2e73660901f688d857c5fb99fcc4c.png" />
</div>
</div>
<p>We can indeed see how the energy error with projection is kept under the <span class="math notranslate nohighlight">\(10^{-6}\)</span> threshold.</p>
<p>We can also take a look at the number of manifold projections performed throughout the integration and compare it to the total number of steps:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of projections: </span><span class="si">{</span><span class="n">cb</span><span class="o">.</span><span class="n">n_proj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of steps: </span><span class="si">{</span><span class="n">pres_proj</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of projections: 3765
Number of steps: 108881
</pre></div>
</div>
</div>
</div>
</section>
</section>


              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="Outer%20Solar%20System.html" title="previous page">Brouwer’s law in the outer Solar System</a>
    <a class='right-next' id="next-link" href="Box%20control%20for%20Formation%20Flying%20Satellites.html" title="next page">Box control in satellite Formation Flying</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Francesco Biscani and Dario Izzo<br/>
        
            &copy; Copyright 2020, 2021, 2022, 2023, Francesco Biscani and Dario Izzo.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.d3f166471bb80abb5163.js"></script>


    
  </body>
</html>