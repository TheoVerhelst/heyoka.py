

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Batch mode &#8212; heyoka.py 2.0.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=ac02cc09edc035673794" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=ac02cc09edc035673794"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/Batch mode overview';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Ensemble propagations" href="ensemble_mode.html" />
    <link rel="prev" title="Advanced tutorials" href="../advanced_tutorials.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/white_logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/white_logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../basic_tutorials.html">Basic tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../tut_taylor_method.html">Taylor’s method</a></li>
<li class="toctree-l2"><a class="reference internal" href="The%20expression%20system.html">The expression system</a></li>
<li class="toctree-l2"><a class="reference internal" href="The%20adaptive%20integrator.html">The adaptive integrator</a></li>
<li class="toctree-l2"><a class="reference internal" href="Customising%20the%20adaptive%20integrator.html">Customising the adaptive integrator</a></li>
<li class="toctree-l2"><a class="reference internal" href="ODEs%20with%20parameters.html">ODEs with parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="Non-autonomous%20systems.html">Non-autonomous systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="Dense%20output.html">Dense &amp; continuous output</a></li>
<li class="toctree-l2"><a class="reference internal" href="Event%20detection.html">Event detection</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../advanced_tutorials.html">Advanced tutorials</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Batch mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="ensemble_mode.html">Ensemble propagations</a></li>
<li class="toctree-l2"><a class="reference internal" href="parallel_mode.html">Parallel mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="ext_precision.html">Computations in extended precision</a></li>
<li class="toctree-l2"><a class="reference internal" href="arbitrary_precision.html">Computations in arbitrary precision</a></li>
<li class="toctree-l2"><a class="reference internal" href="sympy_interop.html">Interoperability with SymPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="compiled_functions.html">Compiled functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="ex_system_revisited.html">Using the expression system effectively</a></li>
<li class="toctree-l2"><a class="reference internal" href="pickling.html">Pickle support</a></li>
<li class="toctree-l2"><a class="reference internal" href="jit_caching.html">JIT compilation and caching</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../examples.html">Examples</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="The%20restricted%20three-body%20problem.html">The restricted three-body problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="Periodic%20orbits%20in%20the%20CR3BP.html">Continuation of Periodic Orbits in the CR3BP</a></li>
<li class="toctree-l2"><a class="reference internal" href="Long%20term%20stability%20of%20Trappist-1.html">Long term stability of N-body simulations: the case of Trappist-1</a></li>
<li class="toctree-l2"><a class="reference internal" href="Outer%20Solar%20System.html">Brouwer’s law in the outer Solar System</a></li>
<li class="toctree-l2"><a class="reference internal" href="projection.html">Conserving first integrals via manifold projection</a></li>
<li class="toctree-l2"><a class="reference internal" href="Box%20control%20for%20Formation%20Flying%20Satellites.html">Box control in satellite Formation Flying</a></li>
<li class="toctree-l2"><a class="reference internal" href="Comparing%20coordinate%20systems.html">Comparing coordinate systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="Inverting%20Kepler%27s%20equation%20in%20ODEs.html">Inverting Kepler’s equation in ODEs</a></li>
<li class="toctree-l2"><a class="reference internal" href="Planetary%20embryos.html">Planetary embryos in the inner Solar System</a></li>
<li class="toctree-l2"><a class="reference internal" href="mercury_precession.html">Mercury’s relativistic precession</a></li>
<li class="toctree-l2"><a class="reference internal" href="ttv.html">Calculating transit timing variations</a></li>
<li class="toctree-l2"><a class="reference internal" href="vsop2013.html">Introduction to the VSOP2013 planetary theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="tides_spokes.html">Elastic tides</a></li>
<li class="toctree-l2"><a class="reference internal" href="Sampling%20events.html">Sampling events</a></li>
<li class="toctree-l2"><a class="reference internal" href="Poincar%C3%A9%20sections.html">Poincaré sections</a></li>
<li class="toctree-l2"><a class="reference internal" href="second_integral.html">The second integral of motion</a></li>
<li class="toctree-l2"><a class="reference internal" href="The%20Keplerian%20billiard.html">The Keplerian billiard</a></li>
<li class="toctree-l2"><a class="reference internal" href="The%20two-fixed%20elliptic%20billiard.html">The two-fixed centres elliptic billiard</a></li>
<li class="toctree-l2"><a class="reference internal" href="The%20wavy%20ramp.html">The wavy ramp</a></li>
<li class="toctree-l2"><a class="reference internal" href="The%20Maxwell-Boltzmann%20distribution.html">The Maxwell-Boltzmann distribution</a></li>
<li class="toctree-l2"><a class="reference internal" href="ev_sensitivity.html">Computing event sensitivity</a></li>
<li class="toctree-l2"><a class="reference internal" href="ensemble_batch_perf.html">Evaluating the performance of ensemble &amp; batch mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="The%20variational%20equations.html">The variational equations</a></li>
<li class="toctree-l2"><a class="reference internal" href="Optimal%20Control%20of%20the%20Lotka-Volterra%20equations.html">Optimal Control of the Lotka-Volterra equations</a></li>
<li class="toctree-l2"><a class="reference internal" href="definite_integrals.html">Computing definite integrals</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../benchmarks.html">Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../breaking_changes.html">Breaking changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../acknowledgement.html">Acknowledgement</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/bluescarni/heyoka.py/main?urlpath=lab/tree/doc/notebooks/Batch mode overview.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/bluescarni/heyoka.py" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/bluescarni/heyoka.py/issues/new?title=Issue%20on%20page%20%2Fnotebooks/Batch mode overview.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/Batch mode overview.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Batch mode</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-adaptive-batch-integrator">The adaptive batch integrator</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-by-step-integration">Step-by-step integration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#time-limited-propagation">Time-limited propagation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dense-output">Dense output</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#continuous-output">Continuous output</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#event-detection">Event detection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ensemble-propagations">Ensemble propagations</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="batch-mode">
<h1>Batch mode<a class="headerlink" href="#batch-mode" title="Permalink to this heading">#</a></h1>
<p>heyoka.py’s API supports a mode of operation called <em>batch mode</em>.
In batch mode, all the scalar quantities appearing in a system of ODEs
(i.e., state variables, time coordinate, parameters, etc.)
are formally replaced by small vectors of fixed size <span class="math notranslate nohighlight">\(n\)</span>, so that,
effectively, multiple ODE systems sharing the same mathematical formulation
are being integrated simultaneously using different sets of numerical values.</p>
<p>Because modern CPUs support <a class="reference external" href="https://en.wikipedia.org/wiki/SIMD">SIMD instructions</a>,
the runtime cost of operating on a vector of <span class="math notranslate nohighlight">\(n\)</span> scalar values is roughly
equivalent to the cost of operating on a single scalar value, and thus the use of
batch mode can lead to an increase in floating-point throughput up to a factor of <span class="math notranslate nohighlight">\(n\)</span>.</p>
<p>It is important to emphasise that batch mode does not reduce
the CPU time required to integrate a system of ODEs. Rather, as a fine-grained
form of data parallelism, batch mode allows to integrate multiple ODE systems in parallel
at no additional cost, and it is thus most useful when the need arise
to integrate the same ODE system with different initial conditions and parameters.</p>
<p>Although batch mode can in principle be used with all floating-point types supported
by heyoka.py, in practice at this time no CPU provides SIMD instructions for extended-precision
datatypes. Thus, here we will consider the application of batch mode only to
standard <code class="docutils literal notranslate"><span class="pre">double</span></code> precision computations.</p>
<p>The value of the batch size <span class="math notranslate nohighlight">\(n\)</span> can be freely chosen by the user. In order
to achieve optimal performance, however, <span class="math notranslate nohighlight">\(n\)</span> should match the SIMD width of the
processor in use. Because at this time the most widespread SIMD instruction set is
<a class="reference external" href="https://en.wikipedia.org/wiki/Advanced_Vector_Extensions">AVX</a> (available on
most x86 processors sold since 2011), and AVX has a SIMD width of 4 for double precision,
in this tutorial we will be using a batch size <span class="math notranslate nohighlight">\(n=4\)</span>.</p>
<p>Starting from heyoka.py 0.17, a function is available to determine the recommended
SIMD width for the CPU currently in use:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">heyoka</span> <span class="k">as</span> <span class="nn">hy</span>

<span class="n">hy</span><span class="o">.</span><span class="n">recommended_simd_size</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
<section id="the-adaptive-batch-integrator">
<h2>The adaptive batch integrator<a class="headerlink" href="#the-adaptive-batch-integrator" title="Permalink to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">taylor_adaptive_batch</span></code> class is the batch mode counterpart of the adaptive
(scalar) integrator <a class="reference internal" href="The%20adaptive%20integrator.html"><span class="doc std std-doc">described earlier</span></a>. Although at a high-level
the API of <code class="docutils literal notranslate"><span class="pre">taylor_adaptive_batch</span></code> is quite similar to the API of
<code class="docutils literal notranslate"><span class="pre">taylor_adaptive</span></code>, there are also some important differences that need to be
pointed out.</p>
<p>In order to present a comprehensive example, we will consider again the integration
of the <a class="reference internal" href="Non-autonomous%20systems.html"><span class="doc std std-doc">forced damped pendulum</span></a>, with a small modification:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{cases}
x^\prime = v \\
v^\prime = \cos t - \alpha v - \sin(x)
\end{cases}.
\end{split}\]</div>
<p>Here <span class="math notranslate nohighlight">\(\alpha\)</span> is an air friction coefficient whose value is left undefined
(i.e., <span class="math notranslate nohighlight">\(\alpha\)</span> is a <a class="reference internal" href="ODEs%20with%20parameters.html"><span class="doc std std-doc">runtime parameter</span></a>).</p>
<p>Let us begin:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create the symbolic variables x and v.</span>
<span class="n">x</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">make_vars</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">)</span>

<span class="c1"># We will be using a batch size of 4.</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">4</span>
</pre></div>
</div>
</div>
</div>
<p>As usual, we begin by creating the symbolic state variables <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(v\)</span>.
We also store in a constant the value of the batch size <span class="math notranslate nohighlight">\(n = 4\)</span> for later use.</p>
<p>Next, we define the equations of motion:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Equations of motion.</span>
<span class="n">eqns</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span>
        <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">hy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">hy</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">-</span> <span class="n">hy</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">v</span> <span class="o">-</span> <span class="n">hy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>
</pre></div>
</div>
</div>
</div>
<p>The friction coefficient <span class="math notranslate nohighlight">\(\alpha\)</span> is implemented as the runtime parameter at index 0 (<code class="docutils literal notranslate"><span class="pre">par[0]</span></code>).</p>
<p>We can now proceed to the creation of the batch integrator. We will need to provide batches of initial conditions for <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(v\)</span>, and a batch of values for the runtime parameter <span class="math notranslate nohighlight">\(\alpha\)</span>. We will choose the following numerical values:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{cases}
x_0 = \left( 0.00, 0.01, 0.02, 0.03 \right ) \\
v_0 = \left( 1.85, 1.86, 1.87, 1.88 \right) \\
\alpha = \left( 0.10, 0.11, 0.12, 0.13 \right)
\end{cases}.
\end{split}\]</div>
<p>Let us see the code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create the integrator object.</span>
<span class="n">ta</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">taylor_adaptive_batch</span><span class="p">(</span>
                        <span class="c1"># The dynamics.</span>
                        <span class="n">eqns</span><span class="p">,</span>
                        <span class="c1"># Initial conditions for x and v.</span>
                        <span class="n">state</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.85</span><span class="p">,</span> <span class="mf">1.86</span><span class="p">,</span> <span class="mf">1.87</span><span class="p">,</span> <span class="mf">1.88</span><span class="p">]],</span>
                        <span class="c1"># Values for alpha.</span>
                        <span class="n">pars</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.11</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.13</span><span class="p">]]</span>
                        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The constructor of <code class="docutils literal notranslate"><span class="pre">taylor_adaptive_batch</span></code> is very similar to the constructor of
<code class="docutils literal notranslate"><span class="pre">taylor_adaptive</span></code>: it has the same mandatory and optional arguments, but the expected
array format for the initial conditions and parameter values is different. Specifically, a batch integrator
expects as initial conditions and parameter values 2D arrays in which the number of columns represents the batch size.
Thus, because in this specific case the array of initial conditions has shape <span class="math notranslate nohighlight">\(\left( 2, 4 \right)\)</span>
and the array of parameter values has shape <span class="math notranslate nohighlight">\(\left( 1, 4 \right)\)</span>, the integrator infers that the batch size is 4.</p>
<p>Because we didn’t provide values for the initial times, the time coordinates are
all initialised to zero:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ta</span><span class="o">.</span><span class="n">time</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0., 0., 0., 0.])
</pre></div>
</div>
</div>
</div>
<p>Note that, contrary to the scalar integrator, in the batch integrator it is not possible to write directly into the array of time coordinates. The <code class="docutils literal notranslate"><span class="pre">set_time()</span></code> method must be used instead.</p>
</section>
<section id="step-by-step-integration">
<h2>Step-by-step integration<a class="headerlink" href="#step-by-step-integration" title="Permalink to this heading">#</a></h2>
<p>We are now ready to start integrating. Like <code class="docutils literal notranslate"><span class="pre">taylor_adaptive</span></code>, <code class="docutils literal notranslate"><span class="pre">taylor_adaptive_batch</span></code>
provides <code class="docutils literal notranslate"><span class="pre">step()</span></code> functions for integrating forward or backward in time step-by-step.
One important difference is that, in order to avoid costly memory allocations,
the <code class="docutils literal notranslate"><span class="pre">step()</span></code> functions of the batch integrator do not return anything. Rather, the
batch integrator maintains an internal vector of outcomes which is updated at the
end of each timestep. Let’s take a look:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform a single step forward in time.</span>
<span class="n">ta</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

<span class="c1"># Print the outcomes to screen.</span>
<span class="n">ta</span><span class="o">.</span><span class="n">step_res</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&lt;taylor_outcome.success: -4294967297&gt;, 0.205181018733418),
 (&lt;taylor_outcome.success: -4294967297&gt;, 0.20619730819002183),
 (&lt;taylor_outcome.success: -4294967297&gt;, 0.20501652806394124),
 (&lt;taylor_outcome.success: -4294967297&gt;, 0.20408393560444854)]
</pre></div>
</div>
</div>
</div>
<p>We can see how the integration timestep was successful for all elements of the batch, and how slightly different timesteps were chosen for each element of the batch.</p>
<p>Let’s also print to screen the updated state and time arrays:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;State:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">time</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>State:
[[0.39386703 0.40729224 0.41636627 0.42592189]
 [1.9748992  1.97901839 1.98231555 1.98573654]]
Time:
[0.20518102 0.20619731 0.20501653 0.20408394]
</pre></div>
</div>
</div>
</div>
<p>Note that because the initial conditions were all set to similar values,
the state of the system after a single timestep also does not change much
across the batch elements.</p>
<p>Like for <code class="docutils literal notranslate"><span class="pre">taylor_adaptive</span></code>, the <code class="docutils literal notranslate"><span class="pre">step()</span></code> function can be invoked with
a vector of time limits: if the adaptive timesteps
selected by heyoka are larger (in absolute value) than the specified limits,
then the timesteps will be clamped.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform a single step forward in time</span>
<span class="c1"># clamping the maximum absolute values</span>
<span class="c1"># of the timesteps.</span>
<span class="n">ta</span><span class="o">.</span><span class="n">step</span><span class="p">([</span><span class="mf">0.010</span><span class="p">,</span> <span class="mf">0.011</span><span class="p">,</span> <span class="mf">0.012</span><span class="p">,</span> <span class="mf">0.013</span><span class="p">])</span>

<span class="c1"># Print the outcomes, state and times to screen.</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Outcomes:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">step_res</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;State:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">time</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Outcomes:
[(&lt;taylor_outcome.time_limit: -4294967299&gt;, 0.01), (&lt;taylor_outcome.time_limit: -4294967299&gt;, 0.011), (&lt;taylor_outcome.time_limit: -4294967299&gt;, 0.012), (&lt;taylor_outcome.time_limit: -4294967299&gt;, 0.013)]
State:
[[0.41363557 0.42908306 0.44017771 0.45176173]
 [1.97877363 1.98290874 1.98620849 1.9895667 ]]
Time:
[0.21518102 0.21719731 0.21701653 0.21708394]
</pre></div>
</div>
</div>
</div>
</section>
<section id="time-limited-propagation">
<h2>Time-limited propagation<a class="headerlink" href="#time-limited-propagation" title="Permalink to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">propagate_*()</span></code> functions are also available for the
batch integrator. Similarly to the <code class="docutils literal notranslate"><span class="pre">step()</span></code> functions, the outcomes of the <code class="docutils literal notranslate"><span class="pre">propagate_*()</span></code>
functions are stored in internal vectors of tuples, with the tuple elements representing:</p>
<ul class="simple">
<li><p>the outcome of the integration,</p></li>
<li><p>the minimum and maximum integration timesteps
that were used in the propagation,</p></li>
<li><p>the total number of steps that were taken.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">propagate_for/until()</span></code> methods in batch mode return the
<a class="reference internal" href="Dense%20output.html"><span class="doc std std-doc">continuous output</span></a> function object
(if requested). The <code class="docutils literal notranslate"><span class="pre">propagate_grid()</span></code> function returns
the result of the integration over a grid of time batches.</p>
<p>Note that, generally speaking, when using the <code class="docutils literal notranslate"><span class="pre">propagate_*()</span></code> functions each batch element will need a different number of integration steps to reach the final time. Thus, when a batch element reaches the final time, further steps for that batch element will be taken with a timestep of zero, until all batch elements reach the final time.</p>
<p>Let’s see a couple of examples:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Propagate for different time intervals.</span>
<span class="n">ta</span><span class="o">.</span><span class="n">propagate_for</span><span class="p">([</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">11.</span><span class="p">,</span> <span class="mf">12.</span><span class="p">,</span> <span class="mf">13.</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Outcomes:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">propagate_res</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;State:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">time</span><span class="p">))</span>

<span class="c1"># Propagate up to different time coordinates.</span>
<span class="n">ta</span><span class="o">.</span><span class="n">propagate_until</span><span class="p">([</span><span class="mf">20.</span><span class="p">,</span> <span class="mf">21.</span><span class="p">,</span> <span class="mf">22.</span><span class="p">,</span> <span class="mf">23.</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Outcomes:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">propagate_res</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;State:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">time</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Outcomes:
[(&lt;taylor_outcome.time_limit: -4294967299&gt;, 0.1970044860947501, 0.42801809235455385, 34), (&lt;taylor_outcome.time_limit: -4294967299&gt;, 0.1914608992952718, 0.4281140304644989, 38), (&lt;taylor_outcome.time_limit: -4294967299&gt;, 0.18762172169221444, 0.4355633488513558, 41), (&lt;taylor_outcome.time_limit: -4294967299&gt;, 0.18423403769248836, 0.4705364610280492, 44)]
State:
[[ 4.6268855   2.73976697  1.1534837   0.23501885]
 [-2.25814471 -1.91965361 -1.77541972 -1.13133003]]
Time:
[10.21518102 11.21719731 12.21701653 13.21708394]

Outcomes:
[(&lt;taylor_outcome.time_limit: -4294967299&gt;, 0.20484738379821055, 0.3080688556802492, 40), (&lt;taylor_outcome.time_limit: -4294967299&gt;, 0.21220873200092283, 0.32033034817214345, 38), (&lt;taylor_outcome.time_limit: -4294967299&gt;, 0.22595995123406554, 0.412964495387597, 35), (&lt;taylor_outcome.time_limit: -4294967299&gt;, 0.21027114609377734, 0.37175365186269704, 34)]
State:
[[1.80080102 2.83619831 3.4747455  6.29634837]
 [1.35919698 0.50159786 0.00737693 0.72663002]]
Time:
[20. 21. 22. 23.]
</pre></div>
</div>
</div>
</div>
<p>Let us now reset the integrator to the original initial conditions, and use <code class="docutils literal notranslate"><span class="pre">propagate_grid()</span></code> to compute and then plot the time evolution of <span class="math notranslate nohighlight">\(x\)</span> for the different batch elements:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reset time and state.</span>
<span class="n">ta</span><span class="o">.</span><span class="n">set_time</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
<span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.85</span><span class="p">,</span> <span class="mf">1.86</span><span class="p">,</span> <span class="mf">1.87</span><span class="p">,</span> <span class="mf">1.88</span><span class="p">]]</span>

<span class="c1"># Create identical time grids.</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">t_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Propagate over the time grids.</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">propagate_grid</span><span class="p">(</span><span class="n">t_grid</span><span class="p">)</span>

<span class="c1"># Plot the time evolution of x.</span>
<span class="kn">from</span> <span class="nn">matplotlib.pylab</span> <span class="kn">import</span> <span class="n">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">out</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Batch element 0&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">out</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Batch element 1&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">out</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Batch element 2&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">out</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Batch element 3&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3d9a890f8e1991a4479ef2535c54ad0ec1e9cd08a818c6511e22b55d32c58617.png" src="../_images/3d9a890f8e1991a4479ef2535c54ad0ec1e9cd08a818c6511e22b55d32c58617.png" />
</div>
</div>
<p>In this example, we chose to propagate all batch elements using the same time grid, but we could have chosen to propagate different batch elements using different time grids.</p>
<p>The plot for the time evolution of <span class="math notranslate nohighlight">\(x\)</span> shows how this dynamical system is sensitive to the initial conditions: whereas batch elements 0 and 1 evolve together towards the same periodic behaviour, batch elements 2 and 3 exhibit a qualitatively-different evolution.</p>
<p>We can print to screen <code class="docutils literal notranslate"><span class="pre">propagate_res</span></code> to find out how many timesteps each batch required and what were the sizes of the smallest and largest integration timesteps:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ta</span><span class="o">.</span><span class="n">propagate_res</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&lt;taylor_outcome.time_limit: -4294967299&gt;,
  0.17712187414656672,
  0.42922678763927685,
  445),
 (&lt;taylor_outcome.time_limit: -4294967299&gt;,
  0.17864079697444862,
  0.43116413615127175,
  442),
 (&lt;taylor_outcome.time_limit: -4294967299&gt;,
  0.17166730017463622,
  0.48845285378323666,
  370),
 (&lt;taylor_outcome.time_limit: -4294967299&gt;,
  0.18536036318220903,
  0.46761939336987596,
  364)]
</pre></div>
</div>
</div>
</div>
<p>An important difference with respect to scalar mode is that the vector returned
by <code class="docutils literal notranslate"><span class="pre">propagate_grid()</span></code> in batch mode always contains values for <em>all</em> grid points,
event if the integration is terminated early (e.g., due to errors or to terminal
events triggering). In scalar mode, by contrast, in case of early termination
<code class="docutils literal notranslate"><span class="pre">propagate_grid()</span></code> returns only the output values for the grid points that
could be computed before the early exit. In batch mode, the values for the grid
points that could not be reached due to early exit are filled with NaNs.</p>
</section>
<section id="dense-output">
<h2>Dense output<a class="headerlink" href="#dense-output" title="Permalink to this heading">#</a></h2>
<p>The batch integrator also supports <a class="reference internal" href="Dense%20output.html"><span class="doc std std-doc">dense output</span></a>. Like for <code class="docutils literal notranslate"><span class="pre">taylor_adaptive</span></code>,
enabling dense output is a two-step process. First we invoke one of the <code class="docutils literal notranslate"><span class="pre">step()</span></code> (or <code class="docutils literal notranslate"><span class="pre">propagate_*()</span></code>) functions
with the optional flag <code class="docutils literal notranslate"><span class="pre">write_tc</span></code> set to <code class="docutils literal notranslate"><span class="pre">True</span></code>. This will write the Taylor coefficients that were
used to propagate the last timestep into an internal vector:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reset time and state.</span>
<span class="n">ta</span><span class="o">.</span><span class="n">set_time</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
<span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.85</span><span class="p">,</span> <span class="mf">1.86</span><span class="p">,</span> <span class="mf">1.87</span><span class="p">,</span> <span class="mf">1.88</span><span class="p">]]</span>

<span class="c1"># Propagate for a timestep, making</span>
<span class="c1"># sure the Taylor coefficients are recorded.</span>
<span class="n">ta</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">write_tc</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Print the array of Taylor coefficients.</span>
<span class="n">ta</span><span class="o">.</span><span class="n">tc</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[[ 0.00000000e+00,  1.00000000e-02,  2.00000000e-02,
          3.00000000e-02],
        [ 1.85000000e+00,  1.86000000e+00,  1.87000000e+00,
          1.88000000e+00],
        [ 4.07500000e-01,  3.92700083e-01,  3.77800667e-01,
          3.62802250e-01],
        [-3.21916667e-01, -3.24383503e-01, -3.26716362e-01,
         -3.28913775e-01],
        [-6.75770833e-02, -6.40280151e-02, -6.04283792e-02,
         -5.67795484e-02],
        [ 7.02109167e-02,  7.16133044e-02,  7.29717323e-02,
          7.42848569e-02],
        [ 2.57157556e-02,  2.45104498e-02,  2.32584223e-02,
          2.19601549e-02],
        [-1.57976537e-02, -1.66107095e-02, -1.74021378e-02,
         -1.81703716e-02],
        [-1.00353587e-02, -9.68202996e-03, -9.29913499e-03,
         -8.88692852e-03],
        [ 3.42185259e-03,  3.80286542e-03,  4.17724062e-03,
          4.54381437e-03],
        [ 3.71632697e-03,  3.63550405e-03,  3.53850922e-03,
          3.42533322e-03],
        [-5.74043833e-04, -7.39223443e-04, -9.03658931e-04,
         -1.06661590e-03],
        [-1.32460887e-03, -1.31766585e-03, -1.30272684e-03,
         -1.27967575e-03],
        [ 8.41486409e-07,  6.80660294e-05,  1.36166728e-04,
          2.04736804e-04],
        [ 4.54537630e-04,  4.61961397e-04,  4.65753785e-04,
          4.65788152e-04],
        [ 6.59812726e-05,  4.02165119e-05,  1.34874974e-05,
         -1.40032406e-05],
        [-1.49384493e-04, -1.56240569e-04, -1.61573706e-04,
         -1.65285583e-04],
        [-4.50881595e-05, -3.58225773e-05, -2.58851228e-05,
         -1.53667581e-05],
        [ 4.64593626e-05,  5.05932052e-05,  5.41409729e-05,
          5.70383152e-05],
        [ 2.29227501e-05,  1.98416708e-05,  1.63700226e-05,
          1.25441216e-05],
        [-1.33367091e-05, -1.54509288e-05, -1.73630712e-05,
         -1.90354790e-05]],

       [[ 1.85000000e+00,  1.86000000e+00,  1.87000000e+00,
          1.88000000e+00],
        [ 8.15000000e-01,  7.85400167e-01,  7.55601333e-01,
          7.25604500e-01],
        [-9.65750000e-01, -9.73150510e-01, -9.80149086e-01,
         -9.86741324e-01],
        [-2.70308333e-01, -2.56112060e-01, -2.41713517e-01,
         -2.27118194e-01],
        [ 3.51054583e-01,  3.58066522e-01,  3.64858662e-01,
          3.71424284e-01],
        [ 1.54294533e-01,  1.47062699e-01,  1.39550534e-01,
          1.31760929e-01],
        [-1.10583576e-01, -1.16274967e-01, -1.21814965e-01,
         -1.27192601e-01],
        [-8.02828694e-02, -7.74562397e-02, -7.43930799e-02,
         -7.10954281e-02],
        [ 3.07966733e-02,  3.42257887e-02,  3.75951656e-02,
          4.08943294e-02],
        [ 3.71632697e-02,  3.63550405e-02,  3.53850922e-02,
          3.42533322e-02],
        [-6.31448217e-03, -8.13145787e-03, -9.94024824e-03,
         -1.17327749e-02],
        [-1.58953064e-02, -1.58119902e-02, -1.56327221e-02,
         -1.53561090e-02],
        [ 1.09393233e-05,  8.84858383e-04,  1.77016746e-03,
          2.66157845e-03],
        [ 6.36352682e-03,  6.46745955e-03,  6.52055299e-03,
          6.52103413e-03],
        [ 9.89719089e-04,  6.03247679e-04,  2.02312461e-04,
         -2.10048609e-04],
        [-2.39015189e-03, -2.49984911e-03, -2.58517929e-03,
         -2.64456933e-03],
        [-7.66498711e-04, -6.08983813e-04, -4.40047088e-04,
         -2.61234887e-04],
        [ 8.36268527e-04,  9.10677694e-04,  9.74537513e-04,
          1.02668967e-03],
        [ 4.35532251e-04,  3.76991746e-04,  3.11030429e-04,
          2.38338310e-04],
        [-2.66734182e-04, -3.09018576e-04, -3.47261424e-04,
         -3.80709580e-04],
        [-2.15100964e-04, -1.95914860e-04, -1.72450071e-04,
         -1.44963795e-04]]])
</pre></div>
</div>
</div>
</div>
<p>Quite a mouthful! Let’s print to screen the order-0 Taylor coefficients
of <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(v\)</span> for all batch elements:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ta</span><span class="o">.</span><span class="n">tc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[0.  , 0.01, 0.02, 0.03],
       [1.85, 1.86, 1.87, 1.88]])
</pre></div>
</div>
</div>
</div>
<p>Indeed, as expected the order-0 Taylor coefficients correspond to the initial conditions.</p>
<p>After computing the Taylor coefficients, we can ask for the dense output
at different time coordinates:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the dense output at different time coordinates.</span>
<span class="n">ta</span><span class="o">.</span><span class="n">update_d_output</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[0.01854043, 0.04735447, 0.07643115, 0.1057593 ],
       [1.85805316, 1.87531675, 1.89177968, 1.90743182]])
</pre></div>
</div>
</div>
</div>
</section>
<section id="continuous-output">
<h2>Continuous output<a class="headerlink" href="#continuous-output" title="Permalink to this heading">#</a></h2>
<p>Starting with heyoka.py 0.16, the batch integrator also supports <a class="reference internal" href="Dense%20output.html"><span class="doc std std-doc">continuous output</span></a>. The batch mode continuous output API is similar to the scalar mode API. Specifically, if the <code class="docutils literal notranslate"><span class="pre">propagate_for/until()</span></code> methods of a batch integrator are invoked with the <code class="docutils literal notranslate"><span class="pre">c_output</span> <span class="pre">=</span> <span class="pre">True</span></code> keyword option, then they will return a function object which can be used to compute the result of the numerical integration at any point of the integration interval:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reset time and state.</span>
<span class="n">ta</span><span class="o">.</span><span class="n">set_time</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
<span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.85</span><span class="p">,</span> <span class="mf">1.86</span><span class="p">,</span> <span class="mf">1.87</span><span class="p">,</span> <span class="mf">1.88</span><span class="p">]]</span>

<span class="c1"># Propagate for a few time units, and request continuous output.</span>
<span class="n">c_out</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">propagate_until</span><span class="p">([</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">10.1</span><span class="p">,</span> <span class="mf">10.2</span><span class="p">,</span> <span class="mf">10.3</span><span class="p">],</span> <span class="n">c_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Like in the scalar case, the call operator of <code class="docutils literal notranslate"><span class="pre">c_out</span></code> in batch mode accepts two types of input:</p>
<ul class="simple">
<li><p>a 1D array of <span class="math notranslate nohighlight">\(n\)</span> times, with each element representing the time at which the continuous output should be computed for the corresponding batch index, or</p></li>
<li><p>a 2D array of with <span class="math notranslate nohighlight">\(n\)</span> columns, with each row representing a batch of time coordinates.</p></li>
</ul>
<p>Let us see a couple of simple examples:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the continuous output for</span>
<span class="c1"># a single batch of times.</span>
<span class="n">c_out</span><span class="p">([</span><span class="mf">.01</span><span class="p">,</span> <span class="mf">.02</span><span class="p">,</span> <span class="mf">.03</span><span class="p">,</span> <span class="mf">.04</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[0.01854043, 0.04735447, 0.07643115, 0.1057593 ],
       [1.85805316, 1.87531675, 1.89177968, 1.90743182]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the continuous output for</span>
<span class="c1"># three batches of times.</span>
<span class="n">c_arr</span> <span class="o">=</span> <span class="n">c_out</span><span class="p">([[</span><span class="mf">.01</span><span class="p">,</span> <span class="mf">.02</span><span class="p">,</span> <span class="mf">.03</span><span class="p">,</span> <span class="mf">.04</span><span class="p">],</span>
               <span class="p">[</span><span class="mf">1.01</span><span class="p">,</span> <span class="mf">1.02</span><span class="p">,</span> <span class="mf">1.03</span><span class="p">,</span> <span class="mf">1.04</span><span class="p">],</span>
               <span class="p">[</span><span class="mf">2.01</span><span class="p">,</span> <span class="mf">2.02</span><span class="p">,</span> <span class="mf">2.03</span><span class="p">,</span> <span class="mf">2.04</span><span class="p">]])</span>
</pre></div>
</div>
</div>
</div>
<p>The shape of <code class="docutils literal notranslate"><span class="pre">c_arr</span></code> is <span class="math notranslate nohighlight">\(\left( 3, 2, 4\right)\)</span>:</p>
<ul class="simple">
<li><p>3 batches of times,</p></li>
<li><p>2 state variables,</p></li>
<li><p>4 batch elements.</p></li>
</ul>
<p>For instance, the value of the <span class="math notranslate nohighlight">\(v\)</span> coordinate at batch index 2 for the first batch of times is:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.8917796783928316
</pre></div>
</div>
</div>
</div>
</section>
<section id="event-detection">
<h2>Event detection<a class="headerlink" href="#event-detection" title="Permalink to this heading">#</a></h2>
<p>Starting with heyoka.py 0.16, the batch integrator also supports <a class="reference internal" href="Event%20detection.html"><span class="doc std std-doc">event detection</span></a>. The batch mode event detection API is similar to the scalar mode API, with the following differences:</p>
<ul class="simple">
<li><p>the event classes in batch mode are called <code class="docutils literal notranslate"><span class="pre">nt_event_batch</span></code> and <code class="docutils literal notranslate"><span class="pre">t_event_batch</span></code>
(for non-terminal and terminal events respectively), rather than <code class="docutils literal notranslate"><span class="pre">nt_event</span></code> and <code class="docutils literal notranslate"><span class="pre">t_event</span></code>;</p></li>
<li><p>with respect to scalar mode, the callback signatures in batch mode feature an extra trailing argument
of type <code class="docutils literal notranslate"><span class="pre">int</span></code> that indicates in which element of the batch the event was detected.</p></li>
</ul>
<p>In order to illustrate how event detection works in batch mode, we will be again integrating
the <a class="reference internal" href="Non-autonomous%20systems.html"><span class="doc std std-doc">forced damped pendulum</span></a>. During the integration, we will
use a non-terminal event to detect when the bob reaches a local amplitude maximum. In other
words, the event equation is</p>
<div class="math notranslate nohighlight">
\[
v = 0,
\]</div>
<p>subject to the constraint that the direction of the event must be <em>negative</em>.</p>
<p>Let us begin with the definition of the callback for the event:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># List of lists in which we will store</span>
<span class="c1"># the times at which the bob is at a local</span>
<span class="c1"># amplitude maximum for each batch element.</span>
<span class="n">max_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">cb</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">d_sgn</span><span class="p">,</span> <span class="n">bidx</span><span class="p">):</span>
    <span class="c1"># Append the local maximum time</span>
    <span class="c1"># for the current batch index.</span>
    <span class="n">max_list</span><span class="p">[</span><span class="n">bidx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we proceed to the definition of the integrator object:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create the integrator object.</span>
<span class="n">ta</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">taylor_adaptive_batch</span><span class="p">(</span>
                        <span class="c1"># The dynamics.</span>
                        <span class="n">eqns</span><span class="p">,</span>
                        <span class="c1"># Initial conditions for x and v.</span>
                        <span class="n">state</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.85</span><span class="p">,</span> <span class="mf">1.86</span><span class="p">,</span> <span class="mf">1.87</span><span class="p">,</span> <span class="mf">1.88</span><span class="p">]],</span>
                        <span class="c1"># Values for alpha.</span>
                        <span class="n">pars</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.11</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.13</span><span class="p">]],</span>
                        <span class="c1"># Non-terminal events.</span>
                        <span class="n">nt_events</span> <span class="o">=</span> <span class="p">[</span><span class="n">hy</span><span class="o">.</span><span class="n">nt_event_batch</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">hy</span><span class="o">.</span><span class="n">event_direction</span><span class="o">.</span><span class="n">negative</span><span class="p">)]</span>
                        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can now propagate over a time grid…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create identical time grids.</span>
<span class="n">t_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Propagate over the time grids.</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">propagate_grid</span><span class="p">(</span><span class="n">t_grid</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>… and visualise the result:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">out</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Batch element 0&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">out</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Batch element 1&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">out</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Batch element 2&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">out</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Batch element 3&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>

<span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">max_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">max_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">max_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">max_list</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/524e272fd23a5330016b2d7c8e054c4bdbeace09eb8c02f46fcdddfe32f3057a.png" src="../_images/524e272fd23a5330016b2d7c8e054c4bdbeace09eb8c02f46fcdddfe32f3057a.png" />
</div>
</div>
<p>Here we marked with vertical dashed lines the times of the local maxima, which, as we can see, were all correctly detected.</p>
<p>As an another example, we will be re-formulating the <a class="reference internal" href="The%20wavy%20ramp.html"><span class="doc std std-doc">wavy ramp tutorial</span></a> in batch mode. The code adaptations for batch mode are small and mostly involve the callbacks and the auxiliary structures to store the coordinates of the bouncing points. The batch elements will feature slightly different initial drop heights for the bouncing ball.</p>
<p>Let us formulate and integrate the problem:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The dynamical variables.</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">make_vars</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">)</span>

<span class="c1"># The dynamics.</span>
<span class="n">eqns</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">vx</span><span class="p">),</span>
        <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">vy</span><span class="p">),</span>
        <span class="p">(</span><span class="n">vx</span><span class="p">,</span> <span class="n">hy</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span><span class="mf">0.</span><span class="p">)),</span>
        <span class="c1"># Downwards constant acceleration.</span>
        <span class="p">(</span><span class="n">vy</span><span class="p">,</span> <span class="n">hy</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span><span class="o">-</span><span class="mf">9.8</span><span class="p">))]</span>

<span class="c1"># Event equation for the ramp.</span>
<span class="n">eq_w_curve</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">hy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">11</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">))</span>

<span class="c1"># Event equation for the ground.</span>
<span class="n">eq_bottom</span> <span class="o">=</span> <span class="n">y</span>

<span class="c1"># The coefficient of restitution.</span>
<span class="n">CR</span> <span class="o">=</span> <span class="mf">.8</span>

<span class="c1"># Global variables to track</span>
<span class="c1"># the time of the last collision</span>
<span class="c1"># and the collision points.</span>
<span class="n">last_t</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span> <span class="o">*</span> <span class="n">batch_size</span>
<span class="n">bounce_points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">))</span>

<span class="c1"># Callback for bouncing against the curve.</span>
<span class="k">def</span> <span class="nf">cb_w_curve</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">d_sgn</span><span class="p">,</span> <span class="n">bidx</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">last_t</span>

    <span class="c1"># If the last collision happened</span>
    <span class="c1"># too recently, return False to</span>
    <span class="c1"># stop the simulation.</span>
    <span class="k">if</span> <span class="n">ta</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">bidx</span><span class="p">]</span> <span class="o">-</span> <span class="n">last_t</span><span class="p">[</span><span class="n">bidx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Update last_t.</span>
    <span class="n">last_t</span><span class="p">[</span><span class="n">bidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">bidx</span><span class="p">]</span>

    <span class="c1"># Update bounce_points.</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="n">bidx</span><span class="p">]</span>
    <span class="n">bounce_points</span><span class="p">[</span><span class="n">bidx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    
    <span class="c1"># Compute the normal unit vector</span>
    <span class="c1"># using the gradient of the event</span>
    <span class="c1"># equation.</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="o">+</span><span class="mf">0.05</span><span class="o">*</span><span class="mi">11</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">11</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">),</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">grad_uvec</span> <span class="o">=</span> <span class="n">grad</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
    
    <span class="c1"># Compute the component of the velocity</span>
    <span class="c1"># across the normal vector.</span>
    <span class="n">xy_vel</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="n">bidx</span><span class="p">]</span>
    <span class="n">vproj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xy_vel</span><span class="p">,</span> <span class="n">grad_uvec</span><span class="p">)</span>
    
    <span class="c1"># Flip it and rescale it according</span>
    <span class="c1"># to the coefficient of restitution.</span>
    <span class="n">Dv</span> <span class="o">=</span> <span class="o">-</span><span class="n">vproj</span><span class="o">*</span><span class="n">grad_uvec</span>
    <span class="n">xy_vel</span> <span class="o">+=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">CR</span><span class="p">)</span> <span class="o">*</span> <span class="n">Dv</span>

    <span class="k">return</span> <span class="kc">True</span>

<span class="c1"># Callback for bouncing off the ground.</span>
<span class="k">def</span> <span class="nf">cb_bottom</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">d_sgn</span><span class="p">,</span> <span class="n">bidx</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">last_t</span>
    
    <span class="c1"># If the last collision happened</span>
    <span class="c1"># too recently, return False to</span>
    <span class="c1"># stop the simulation.</span>
    <span class="k">if</span> <span class="n">ta</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">bidx</span><span class="p">]</span> <span class="o">-</span> <span class="n">last_t</span><span class="p">[</span><span class="n">bidx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Update last_t.</span>
    <span class="n">last_t</span><span class="p">[</span><span class="n">bidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">bidx</span><span class="p">]</span>

    <span class="c1"># Update bounce_points.</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="n">bidx</span><span class="p">]</span>
    <span class="n">bounce_points</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    
    <span class="c1"># Flip the y component of the velocity,</span>
    <span class="c1"># and rescale it according</span>
    <span class="c1"># to the coefficient of restitution.</span>
    <span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">bidx</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">CR</span><span class="o">*</span><span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">bidx</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="kc">True</span>

<span class="c1"># Create the batch integrator.</span>
<span class="n">ta</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">taylor_adaptive_batch</span><span class="p">(</span><span class="n">eqns</span><span class="p">,</span>
                              <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">batch_size</span><span class="p">,</span>
                               <span class="c1"># Set slightly different drop heights</span>
                               <span class="c1"># for each batch element.</span>
                               <span class="nb">list</span><span class="p">(</span><span class="mf">1.2</span> <span class="o">-</span> <span class="n">i</span><span class="o">/</span><span class="mi">50</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)),</span>
                               <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">batch_size</span><span class="p">,</span>
                               <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">batch_size</span><span class="p">],</span>
                              <span class="n">t_events</span> <span class="o">=</span> <span class="p">[</span><span class="n">hy</span><span class="o">.</span><span class="n">t_event_batch</span><span class="p">(</span><span class="n">eq_w_curve</span><span class="p">,</span> <span class="n">callback</span> <span class="o">=</span> <span class="n">cb_w_curve</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">event_direction</span><span class="o">.</span><span class="n">negative</span><span class="p">),</span>
                                          <span class="n">hy</span><span class="o">.</span><span class="n">t_event_batch</span><span class="p">(</span><span class="n">eq_bottom</span><span class="p">,</span> <span class="n">callback</span> <span class="o">=</span> <span class="n">cb_bottom</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">event_direction</span><span class="o">.</span><span class="n">negative</span><span class="p">)])</span>

<span class="c1"># Define the time grids and integrate.</span>
<span class="n">t_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10000</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">propagate_grid</span><span class="p">(</span><span class="n">t_grid</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let us now take a look at the result:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

<span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">bidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">res</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="n">bidx</span><span class="p">],</span><span class="n">res</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="n">bidx</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">bidx</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.75</span><span class="p">)</span>
    <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x_grid</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">11</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x_grid</span><span class="p">)),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">b_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounce_points</span><span class="p">[</span><span class="n">bidx</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">b_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">bidx</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.75</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x_grid</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">11</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x_grid</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">.1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/918bb7e4e7ce6f504270975bd5b4784d12eeb574a8f2abb4e2af36ade3c5c1d2.png" src="../_images/918bb7e4e7ce6f504270975bd5b4784d12eeb574a8f2abb4e2af36ade3c5c1d2.png" />
</div>
</div>
<p>We can see how setting slightly different drop heights for each batch element soon leads to qualitatively-different trajectories.</p>
</section>
<section id="ensemble-propagations">
<h2>Ensemble propagations<a class="headerlink" href="#ensemble-propagations" title="Permalink to this heading">#</a></h2>
<p><a class="reference internal" href="ensemble_mode.html"><span class="doc std std-doc">Ensemble propagations</span></a> are also available in batch mode. The API is identical
to scalar mode ensemble propagations. Specifically, the following functions are available:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ensemble_propagate_until_batch()</span></code>, for batch ensemble propagations
up to a specified epoch,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ensemble_propagate_for_batch()</span></code>, for batch ensemble propagations
for a time interval,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ensemble_propagate_grid_batch()</span></code>, for batch ensemble propagations
over a time grid.</p></li>
</ul>
<p>Like their scalar counterparts, the batch ensemble propagation functions accept in input:</p>
<ul class="simple">
<li><p>the template batch integrator <code class="docutils literal notranslate"><span class="pre">ta</span></code>,</p></li>
<li><p>the final epoch, time interval or time grid to be used in the propagations,</p></li>
<li><p>the number of iterations <code class="docutils literal notranslate"><span class="pre">n_iter</span></code> in the ensemble,</p></li>
<li><p>the generator <code class="docutils literal notranslate"><span class="pre">gen</span></code>.</p></li>
</ul>
<p>Note however that, whereas the <code class="docutils literal notranslate"><span class="pre">propagate_*()</span></code> member functions of the batch integrator
allow to use distinct epochs, time intervals or time grids for each batch element, in batch ensemble
propagations a single epoch, time interval or time grid is used for <em>all</em> batch elements in <em>all</em> iterations
of the ensemble. In particular, while the <code class="docutils literal notranslate"><span class="pre">propagate_grid()</span></code> member function of the batch integrator
expects a 2D array in input (i.e., an array of time batches), the <code class="docutils literal notranslate"><span class="pre">ensemble_propagate_grid_batch()</span></code>
function expects in input a 1D array (i.e., an array of scalars, just like the scalar
<code class="docutils literal notranslate"><span class="pre">propagate_grid()</span></code> member function).</p>
<p>Let us a show a simple example, based again on the <a class="reference internal" href="Non-autonomous%20systems.html"><span class="doc std std-doc">forced damped pendulum</span></a>.
We begin with the definition of the dynamical equations and of the template integrator:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Equations of motion.</span>
<span class="n">eqns</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span>
        <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">hy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">hy</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">-</span> <span class="n">hy</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">v</span> <span class="o">-</span> <span class="n">hy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>

<span class="c1"># Create the template integrator.</span>
<span class="n">ta</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">taylor_adaptive_batch</span><span class="p">(</span>
                        <span class="c1"># The dynamics.</span>
                        <span class="n">eqns</span><span class="p">,</span>
                        <span class="c1"># Zero out the initial conditions</span>
                        <span class="c1"># and the values for the runtime</span>
                        <span class="c1"># parameters</span>
                        <span class="n">state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span>
                        <span class="n">pars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we randomly generate 10 sets of batches of values which we will use to perturb the initial conditions and the runtime parameters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Randomly generate perturbations on the initial conditions</span>
<span class="c1"># and on the values of the friction constant.</span>
<span class="n">delta_ics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">1e-1</span><span class="p">,</span> <span class="mf">1e-1</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">delta_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1e-1</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>We can now proceed with the definition of the generator, which will assign to each batch integrator randomly-generated initial conditions and runtime parameter values based on the <code class="docutils literal notranslate"><span class="pre">delta_ics</span></code> and <code class="docutils literal notranslate"><span class="pre">delta_params</span></code> arrays we just created:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gen</span><span class="p">(</span><span class="n">ta_copy</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
    <span class="n">ta_copy</span><span class="o">.</span><span class="n">set_time</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
    
    <span class="n">ta_copy</span><span class="o">.</span><span class="n">state</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.85</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="n">delta_ics</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">ta_copy</span><span class="o">.</span><span class="n">pars</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="mf">0.1</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="n">delta_params</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">ta_copy</span>
</pre></div>
</div>
</div>
</div>
<p>We are now ready to run the ensemble propagation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">ensemble_propagate_until_batch</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="mf">100.</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">gen</span><span class="p">,</span> <span class="n">c_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let us summarise in a single plot the time evolution of the <span class="math notranslate nohighlight">\(x\)</span> coordinate for <em>all</em> batch elements in <em>all</em> the ensemble iterations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib.pylab</span> <span class="kn">import</span> <span class="n">plt</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Create a range of time batches.</span>
<span class="n">t_rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">100.</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">:</span>
    <span class="c1"># Fetch the continuous output function object.</span>
    <span class="n">c_out</span> <span class="o">=</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_rng</span><span class="p">,</span> <span class="n">c_out</span><span class="p">(</span><span class="n">t_rng</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$t$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$x$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ab9cf267083977ccd7107c853dea5c2e731cdef3d156b96cf500018f2ec86ca0.png" src="../_images/ab9cf267083977ccd7107c853dea5c2e731cdef3d156b96cf500018f2ec86ca0.png" />
</div>
</div>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="../advanced_tutorials.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Advanced tutorials</p>
      </div>
    </a>
    <a class="right-next"
       href="ensemble_mode.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Ensemble propagations</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-adaptive-batch-integrator">The adaptive batch integrator</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-by-step-integration">Step-by-step integration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#time-limited-propagation">Time-limited propagation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dense-output">Dense output</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#continuous-output">Continuous output</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#event-detection">Event detection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ensemble-propagations">Ensemble propagations</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Francesco Biscani and Dario Izzo
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2020, 2021, 2022, 2023, Francesco Biscani and Dario Izzo.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>