
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Ensemble propagations &#8212; heyoka.py 0.21.0 documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Parallel mode" href="parallel_mode.html" />
    <link rel="prev" title="Batch mode" href="Batch%20mode%20overview.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/white_logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">heyoka.py 0.21.0 documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contents
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../install.html">
   Installation
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../tutorials.html">
   Tutorials
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="../tut_taylor_method.html">
     Taylor’s method
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20expression%20system.html">
     The expression system
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20adaptive%20integrator.html">
     The adaptive integrator
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Customising%20the%20adaptive%20integrator.html">
     Customising the adaptive integrator
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ODEs%20with%20parameters.html">
     ODEs with parameters
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Non-autonomous%20systems.html">
     Non-autonomous systems
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Dense%20output.html">
     Dense &amp; continuous output
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Event%20detection.html">
     Event detection
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Batch%20mode%20overview.html">
     Batch mode
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Ensemble propagations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="parallel_mode.html">
     Parallel mode
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ext_precision.html">
     Computations in extended precision
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="arbitrary_precision.html">
     Computations in arbitrary precision
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="sympy_interop.html">
     Interoperability with SymPy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="compiled_functions.html">
     Compiled functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pickling.html">
     Pickle support
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../examples.html">
   Examples
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20restricted%20three-body%20problem.html">
     The restricted three-body problem
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Periodic%20orbits%20in%20the%20CR3BP.html">
     Continuation of Periodic Orbits in the CR3BP
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Long%20term%20stability%20of%20Trappist-1.html">
     Long term stability of N-body simulations: the case of Trappist-1
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Outer%20Solar%20System.html">
     Brouwer’s law in the outer Solar System
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Box%20control%20for%20Formation%20Flying%20Satellites.html">
     Box control in satellite Formation Flying
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Comparing%20coordinate%20systems.html">
     Comparing coordinate systems
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Inverting%20Kepler%27s%20equation%20in%20ODEs.html">
     Inverting Kepler’s equation in ODEs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Planetary%20embryos.html">
     Planetary embryos in the inner Solar System
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="mercury_precession.html">
     Mercury’s relativistic precession
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ttv.html">
     Calculating transit timing variations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="vsop2013.html">
     Introduction to the VSOP2013 planetary theory
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="tides_spokes.html">
     Elastic tides
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Sampling%20events.html">
     Sampling events
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Poincar%C3%A9%20sections.html">
     Poincaré sections
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="second_integral.html">
     The second integral of motion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20Keplerian%20billiard.html">
     The Keplerian billiard
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20two-fixed%20elliptic%20billiard.html">
     The two-fixed centres elliptic billiard
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20wavy%20ramp.html">
     The wavy ramp
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20Maxwell-Boltzmann%20distribution.html">
     The Maxwell-Boltzmann distribution
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ev_sensitivity.html">
     Computing event sensitivity
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ensemble_batch_perf.html">
     Evaluating the performance of ensemble &amp; batch mode
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20variational%20equations.html">
     The variational equations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Optimal%20Control%20of%20the%20Lotka-Volterra%20equations.html">
     Optimal Control of the Lotka-Volterra equations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="definite_integrals.html">
     Computing definite integrals
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../benchmarks.html">
   Benchmarks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../changelog.html">
   Changelog
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../breaking_changes.html">
   Breaking changes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../acknowledgement.html">
   Acknowledgement
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/bluescarni/heyoka.py/main?urlpath=lab/tree/doc/notebooks/ensemble_mode.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/bluescarni/heyoka.py"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/bluescarni/heyoka.py/issues/new?title=Issue%20on%20page%20%2Fnotebooks/ensemble_mode.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/notebooks/ensemble_mode.ipynb.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-simple-example">
   A simple example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#choosing-between-threads-and-processes">
   Choosing between threads and processes
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Ensemble propagations</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-simple-example">
   A simple example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#choosing-between-threads-and-processes">
   Choosing between threads and processes
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="ensemble-propagations">
<h1>Ensemble propagations<a class="headerlink" href="#ensemble-propagations" title="Permalink to this headline">#</a></h1>
<p>Starting with version 0.17.0, heyoka.py offers support for
<em>ensemble propagations</em>. In ensemble mode, multiple distinct
instances of the same ODE system are integrated in parallel,
typically using different sets of initial conditions and/or
<a class="reference internal" href="Non-autonomous%20systems.html"><span class="doc std std-doc">runtime parameters</span></a>.
Monte Carlo simulations and parameter
searches are two typical examples of tasks in which ensemble mode
is particularly useful.</p>
<p>The ensemble mode API mirrors the time-limited propagation
functions available in the
<a class="reference internal" href="The%20adaptive%20integrator.html"><span class="doc std std-doc">adaptive integrator class</span></a>. Specifically,
three functions are available:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ensemble_propagate_until()</span></code>, for ensemble propagations
up to a specified epoch,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ensemble_propagate_for()</span></code>, for ensemble propagations
for a time interval,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ensemble_propagate_grid()</span></code>, for ensemble propagations
over a time grid.</p></li>
</ul>
<p>In this tutorial, we will be focusing on the <code class="docutils literal notranslate"><span class="pre">ensemble_propagate_until()</span></code>
function, but adapting the code to the other two functions
should be straightforward.</p>
<p>At this time, ensemble propagations can use multiple threads of executions or multiple processes
to achieve parallelisation. In the future, additional parallelisation
modes (e.g., distributed) may be added.</p>
<section id="a-simple-example">
<h2>A simple example<a class="headerlink" href="#a-simple-example" title="Permalink to this headline">#</a></h2>
<p>As usual, for this illustrative tutorial we will be using the ODEs of the simple pendulum.
Thus, let us begin with the definition of the symbolic variables and of an integrator object:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">heyoka</span> <span class="k">as</span> <span class="nn">hy</span>

<span class="n">x</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">make_vars</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">)</span>

<span class="c1"># Create the integrator object.</span>
<span class="n">ta</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">taylor_adaptive</span><span class="p">(</span>
                        <span class="c1"># Definition of the ODE system:</span>
                        <span class="c1"># x&#39; = v</span>
                        <span class="c1"># v&#39; = -9.8 * sin(x)</span>
                        <span class="n">sys</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span>
                         <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.8</span> <span class="o">*</span> <span class="n">hy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">))],</span>
                        <span class="c1"># Initial conditions for x and v.</span>
                        <span class="n">state</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span> <span class="p">,</span><span class="mf">0.</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Note how, differently from the other tutorials, here we have set the initial conditions
to zeroes. This is because, in ensemble mode, we will never use directly the <code class="docutils literal notranslate"><span class="pre">ta</span></code> object to perform
a numerical integration. Rather, <code class="docutils literal notranslate"><span class="pre">ta</span></code> acts as a <em>template</em> from which other integrator
objects will be constructed, and thus its initial conditions are inconsequential.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ensemble_propagate_until()</span></code> function takes in input at least 4 arguments:</p>
<ul class="simple">
<li><p>the template integrator <code class="docutils literal notranslate"><span class="pre">ta</span></code>,</p></li>
<li><p>the final epoch <code class="docutils literal notranslate"><span class="pre">t</span></code> for the propagations (this argument would be a time interval <code class="docutils literal notranslate"><span class="pre">delta_t</span></code>
for <code class="docutils literal notranslate"><span class="pre">ensemble_propagate_for()</span></code> and a time grid for <code class="docutils literal notranslate"><span class="pre">ensemble_propagate_grid()</span></code>),</p></li>
<li><p>the number of iterations <code class="docutils literal notranslate"><span class="pre">n_iter</span></code> in the ensemble,</p></li>
<li><p>a function object <code class="docutils literal notranslate"><span class="pre">gen</span></code>, known as the <em>generator</em>.</p></li>
</ul>
<p>The generator is a callable that takes two input arguments:</p>
<ul class="simple">
<li><p>a <em>deep copy</em> of the template integrator <code class="docutils literal notranslate"><span class="pre">ta</span></code>, and</p></li>
<li><p>an iteration index <code class="docutils literal notranslate"><span class="pre">idx</span></code> in the <code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">n_iter)</span></code> range.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">gen</span></code> is then expected to modify the copy of <code class="docutils literal notranslate"><span class="pre">ta</span></code> (e.g., by setting its initial conditions to specific
values) and return it.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ensemble_propagate_until()</span></code> function iterates over
the <code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">n_iter)</span></code> range. At each iteration, the generator <code class="docutils literal notranslate"><span class="pre">gen</span></code> is invoked,
with the template integrator as the first argument and the current iteration number
as the second argument. The <code class="docutils literal notranslate"><span class="pre">propagate_until()</span></code> member
function is then called on the integrator returned by <code class="docutils literal notranslate"><span class="pre">gen</span></code>, and the result of the propagation
is appended to a list of results which is finally returned by
<code class="docutils literal notranslate"><span class="pre">ensemble_propagate_until()</span></code> once all the propagations have finished.</p>
<p>Let us see a concrete example of <code class="docutils literal notranslate"><span class="pre">ensemble_propagate_until()</span></code> in action. First, we
begin by creating 10 sets of different initial conditions to be used in the ensemble
propagations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create 10 sets of random initial conditions,</span>
<span class="c1"># one for each element of the ensemble.</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">ensemble_ics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">1e-2</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we define a generator that will pick a set of initial conditions from <code class="docutils literal notranslate"><span class="pre">ensemble_ics</span></code>,
depending on the iteration index:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The generator.</span>
<span class="k">def</span> <span class="nf">gen</span><span class="p">(</span><span class="n">ta_copy</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
    <span class="c1"># Reset the time to zero.</span>
    <span class="n">ta</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="mf">0.</span>
    
    <span class="c1"># Fetch initial conditions from ensemble_ics.</span>
    <span class="n">ta_copy</span><span class="o">.</span><span class="n">state</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ensemble_ics</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ta_copy</span>
</pre></div>
</div>
</div>
</div>
<p>We are now ready to invoke the <code class="docutils literal notranslate"><span class="pre">ensemble_propagate_until()</span></code> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the ensemble propagation up to t = 20.</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">ensemble_propagate_until</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="mf">20.</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">gen</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The value returned by <code class="docutils literal notranslate"><span class="pre">ensemble_propagate_until()</span></code> is a list of tuples constructed by concatenating the integrator
object used for each integration and the tuple returned by each <code class="docutils literal notranslate"><span class="pre">propagate_until()</span></code> invocation. This way, at the end
of an ensemble propagation it is possible to inspect both the state of each integrator object and the output of
each invocation of <code class="docutils literal notranslate"><span class="pre">propagate_until()</span></code> (including, e.g., the <a class="reference internal" href="Dense%20output.html"><span class="doc std std-doc">continuous output</span></a>, if
requested).</p>
<p>For instance, let us take a look at the first value in ret:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(Tolerance               : 2.220446049250313e-16
 High accuracy           : false
 Compact mode            : false
 Taylor order            : 20
 Dimension               : 2
 Time                    : 20
 State                   : [0.049545662443560054, 0.06981328213026154],
 &lt;taylor_outcome.time_limit: -4294967299&gt;,
 0.19916978720333753,
 0.2193213218822828,
 98,
 None)
</pre></div>
</div>
</div>
</div>
<p>The first element of the tuple is the integrator object that was used in the invocation of <code class="docutils literal notranslate"><span class="pre">propagate_until()</span></code>. The remaining elements of the tuple are the output of the <code class="docutils literal notranslate"><span class="pre">propagate_until()</span></code> invocation (i.e., integration outcome, min/max timestep, etc., as detailed in the <a class="reference internal" href="The%20adaptive%20integrator.html"><span class="doc std std-doc">adatpive integrator tutorial</span></a>).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ensemble_propagate_until()</span></code> function can be invoked with additional optional keyword arguments, beside the mandatory initial 4:</p>
<ul class="simple">
<li><p>the <code class="docutils literal notranslate"><span class="pre">algorithm</span></code> keyword argument is a string that specifies the parallelisation algorithm that will be used by <code class="docutils literal notranslate"><span class="pre">ensemble_propagate_until()</span></code>. The supported values are currently <code class="docutils literal notranslate"><span class="pre">&quot;thread&quot;</span></code> (the default) and <code class="docutils literal notranslate"><span class="pre">&quot;process&quot;</span></code> (see below for a discussion of the pros and cons of each method);</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">max_workers</span></code> keyword argument is an integer that specifies how many workers are spawned during parallelisation. Defaults to <code class="docutils literal notranslate"><span class="pre">None</span></code>, see the <a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html">Python docs</a> for a detailed explanation;</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">chunksize</span></code> keyword argument is an integer that specifies the size of the tasks that are submitted to the parallel workers. Defaults to 1, see the <a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html">Python docs</a> for a detailed explanation.
This keyword argument can be specified only when using the <code class="docutils literal notranslate"><span class="pre">process</span></code> parallelisation method.</p></li>
</ul>
<p>Any other keyword argument passed to <code class="docutils literal notranslate"><span class="pre">ensemble_propagate_until()</span></code> will be forwarded to the <code class="docutils literal notranslate"><span class="pre">propagate_until()</span></code> invocations.</p>
<p>Let us see a comprehensive example with multiple keyword arguments:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">ensemble_propagate_until</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="mf">20.</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">gen</span><span class="p">,</span>
                                  <span class="c1"># Use no more than 8 worker threads.</span>
                                  <span class="n">max_workers</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
                                  <span class="c1"># Request continuous output.</span>
                                  <span class="n">c_output</span> <span class="o">=</span> <span class="kc">True</span>
                                 <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let us now use the continuous output to plot the evolution of the <span class="math notranslate nohighlight">\(x\)</span> coordinate over time for each element of the ensemble:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib.pylab</span> <span class="kn">import</span> <span class="n">plt</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Create a time range.</span>
<span class="n">t_rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">10.</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>

<span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">:</span>
    <span class="c1"># Fetch the continuous output function object.</span>
    <span class="n">c_out</span> <span class="o">=</span> <span class="n">tup</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_rng</span><span class="p">,</span> <span class="n">c_out</span><span class="p">(</span><span class="n">t_rng</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$t$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$x$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/768e70f04874131d7c99ae9b477028f52ed482286b710a236ee464e30ed86b99.png" src="../_images/768e70f04874131d7c99ae9b477028f52ed482286b710a236ee464e30ed86b99.png" />
</div>
</div>
</section>
<section id="choosing-between-threads-and-processes">
<h2>Choosing between threads and processes<a class="headerlink" href="#choosing-between-threads-and-processes" title="Permalink to this headline">#</a></h2>
<p>Ensemble propagations default to using multiple threads of execution for parallelisation. Multithreading usually performs better than multiprocessing, however there are at least two big caveats to keep in mind when using multithreading:</p>
<ul>
<li><p>first, it is the user’s responsibility to ensure that the user-provided function objects such as the generator and
the callbacks (if present) are safe for use in a multithreaded context. In particular, the following actions will be performed
concurrently by separate threads of execution:</p>
<ul class="simple">
<li><p>invocation of the generator’s call operator and of the call operator
of the callback that can (optionally) be passed to the <code class="docutils literal notranslate"><span class="pre">propagate_*()</span></code>
functions. In other words, both the generator and the <code class="docutils literal notranslate"><span class="pre">propagate_*()</span></code>
callback are shared among several threads of execution and used
concurrently;</p></li>
<li><p>deep copy of the events callbacks and invocation of the
call operator on the copies. That is, each thread of execution
gets its own copy of the event callbacks thanks to the creation
of a new integrator object via the generator.</p></li>
</ul>
<p>For instance, an event callback which performs write operations
on a global variable without using some form of synchronisation
will result in unpredictable behaviour when used in an ensemble propagation.
Similarly, a <code class="docutils literal notranslate"><span class="pre">propagate_*()</span></code> callback that
performs write operations into its own data member(s) without
synchronisation will also result in a data race, because the
<code class="docutils literal notranslate"><span class="pre">propagate_*()</span></code> callback is shared among several threads;</p>
</li>
<li><p>second, due to the <a class="reference external" href="https://docs.python.org/3/glossary.html#term-global-interpreter-lock">global interpreter lock (GIL)</a>, Python is typically not able to execute code concurrently from multiple threads.
Thus, if a considerable portion of the integration time if spent executing user-defined callbacks, ensemble simulations will exhibit poor parallel speedup.</p></li>
</ul>
<p>As an alternative, it is possible to use multiple <em>processes</em> (instead of threads) when performing ensemble propagations by passing the keyword argument <code class="docutils literal notranslate"><span class="pre">algorithm=&quot;process&quot;</span></code>. Processes have a higher initial creation overhead, but they also feature two important advantages:</p>
<ul class="simple">
<li><p>there are no safety concerns regarding data sharing, as each process gets its own copy of all the data necessary to perform an integration;</p></li>
<li><p>the GIL performance issues are avoided because there are multiple Python interpreters running in parallel (rather than multiple threads sharing exclusive access to a single interpreter), and thus ensemble propagations with event detection may parallelise more efficiently when using multiprocessing.</p></li>
</ul>
<p>When employing multiprocessing, users should be aware that the <code class="docutils literal notranslate"><span class="pre">chunksize</span></code> keyword argument can have a big influence on performance. Please see the explanation in the <a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html">Python docs</a> for more detailed information.</p>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="Batch%20mode%20overview.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Batch mode</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="parallel_mode.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Parallel mode</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Francesco Biscani and Dario Izzo<br/>
  
      &copy; Copyright 2020, 2021, 2022, 2023, Francesco Biscani and Dario Izzo.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>