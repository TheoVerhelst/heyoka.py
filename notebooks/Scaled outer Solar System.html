
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The scaled outer Solar System &#8212; heyoka.py 0.15.0 documentation</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Planetary embryos in the inner Solar System" href="Planetary%20embryos.html" />
    <link rel="prev" title="Inverting Kepler’s equation in ODEs" href="Inverting%20Kepler%27s%20equation%20in%20ODEs.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/white_logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">heyoka.py 0.15.0 documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p class="caption" role="heading">
 <span class="caption-text">
  Contents
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../install.html">
   Installation
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../tutorials.html">
   Tutorials
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../tut_taylor_method.html">
     Taylor’s method
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20expression%20system.html">
     The expression system
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20adaptive%20integrator.html">
     The adaptive integrator
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Customising%20the%20adaptive%20integrator.html">
     Customising the adaptive integrator
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ODEs%20with%20parameters.html">
     ODEs with parameters
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Non-autonomous%20systems.html">
     Non-autonomous systems
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Dense%20output.html">
     Dense output
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="sympy_interop.html">
     Interoperability with SymPy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pickling.html">
     Pickle support
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Batch%20mode%20overview.html">
     Batch mode
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Event%20detection.html">
     Event detection overview
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Sampling%20events.html">
     Sampling events
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Poincar%C3%A9%20sections.html">
     Poincaré sections
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20Keplerian%20billiard.html">
     The Keplerian billiard
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20two-fixed%20elliptic%20billiard.html">
     The two-fixed centres elliptic billiard
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20wavy%20ramp.html">
     The wavy ramp
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20Maxwell-Boltzmann%20distribution.html">
     The Maxwell-Boltzmann distribution
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../examples.html">
   Examples
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="The%20restricted%20three-body%20problem.html">
     The restricted three-body problem
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Long%20term%20stability%20of%20Trappist-1.html">
     Long term stability of N-body simulations: the case of Trappist-1
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Outer%20Solar%20System.html">
     Brouwer’s law in the outer Solar System
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Box%20control%20for%20Formation%20Flying%20Satellites.html">
     Box control in satellite Formation Flying
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Comparing%20coordinate%20systems.html">
     Comparing coordinate systems
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Inverting%20Kepler%27s%20equation%20in%20ODEs.html">
     Inverting Kepler’s equation in ODEs
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     The scaled outer Solar System
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Planetary%20embryos.html">
     Planetary embryos in the inner Solar System
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="mercury_precession.html">
     Mercury’s relativistic precession
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ttv.html">
     Calculating transit timing variations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="vsop2013.html">
     Introduction to the VSOP2013 planetary theory
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="tides_spokes.html">
     Elastic tides
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="second_integral.html">
     The second integral of motion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="The%20variational%20equations.html">
     The variational equations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Optimal%20Control%20of%20the%20Lotka-Volterra%20equations.html">
     Optimal Control of the Lotka-Volterra equations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="definite_integrals.html">
     Computing definite integrals
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../changelog.html">
   Changelog
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../breaking_changes.html">
   Breaking changes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../acknowledgement.html">
   Acknowledgement
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/notebooks/Scaled outer Solar System.ipynb.txt"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/bluescarni/heyoka.py"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/bluescarni/heyoka.py/issues/new?title=Issue%20on%20page%20%2Fnotebooks/Scaled outer Solar System.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/bluescarni/heyoka.py/main?urlpath=lab/tree/doc/notebooks/Scaled outer Solar System.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="the-scaled-outer-solar-system">
<h1>The scaled outer Solar System<a class="headerlink" href="#the-scaled-outer-solar-system" title="Permalink to this headline">¶</a></h1>
<p>In this example we will be studying a rescaled version of the outer Solar System in which the masses of the 4 giant planets (Jupiter, Saturn, Uranus and Neptune) have been increased by a factor of 50. It is <a class="reference external" href="https://iopscience.iop.org/article/10.1086/300541/meta">well known</a> that such a configuration is dynamically unstable: in the short term the planets undergo close encounters which eventually lead to the expulsion of one or more planets from the Solar System. We will use this setup to illustrate a creative way of exploiting heyoka.py’s event detection system.</p>
<p>We begin with the definition of the system’s parameters and initial conditions (taken from the <a class="reference internal" href="Outer%20Solar%20System.html"><span class="doc std std-doc">Brouwer’s law example</span></a>):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Blowup factor.</span>
<span class="n">bfac</span> <span class="o">=</span> <span class="mi">50</span>

<span class="c1"># Masses: Sun, Jupiter, Saturn, Uranus, Neptune.</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">masses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.00000597682</span><span class="p">,</span> <span class="n">bfac</span> <span class="o">/</span> <span class="mf">1047.355</span><span class="p">,</span> <span class="n">bfac</span> <span class="o">/</span> <span class="mf">3501.6</span><span class="p">,</span> <span class="n">bfac</span> <span class="o">/</span> <span class="mf">22869.</span><span class="p">,</span> <span class="n">bfac</span> <span class="o">/</span> <span class="mf">19314.</span><span class="p">])</span>

<span class="c1"># The gravitational constant.</span>
<span class="n">G</span> <span class="o">=</span> <span class="mf">0.01720209895</span> <span class="o">*</span> <span class="mf">0.01720209895</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">365</span>

<span class="c1"># Initial conditions.</span>
<span class="n">ic</span> <span class="o">=</span> <span class="p">[</span><span class="c1"># Sun.</span>
      <span class="o">-</span><span class="mf">4.06428567034226e-3</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.08813756435987e-3</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.66162304225834e-6</span><span class="p">,</span> <span class="o">+</span><span class="mf">6.69048890636161e-6</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span>
      <span class="o">-</span><span class="mf">6.33922479583593e-6</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.13202145590767e-9</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span>
      <span class="c1"># Jupiter.</span>
      <span class="o">+</span><span class="mf">3.40546614227466e+0</span><span class="p">,</span> <span class="o">+</span><span class="mf">3.62978190075864e+0</span><span class="p">,</span> <span class="o">+</span><span class="mf">3.42386261766577e-2</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.59797969310664e-3</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span>
      <span class="o">+</span><span class="mf">5.51815399480116e-3</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.66711392865591e-6</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span>
      <span class="c1"># Saturn.</span>
      <span class="o">+</span><span class="mf">6.60801554403466e+0</span><span class="p">,</span> <span class="o">+</span><span class="mf">6.38084674585064e+0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.36145963724542e-1</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.17354020307064e-3</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span>
      <span class="o">+</span><span class="mf">3.99723751748116e-3</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span> <span class="o">+</span><span class="mf">1.67206320571441e-5</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span>
      <span class="c1"># Uranus.</span>
      <span class="o">+</span><span class="mf">1.11636331405597e+1</span><span class="p">,</span> <span class="o">+</span><span class="mf">1.60373479057256e+1</span><span class="p">,</span> <span class="o">+</span><span class="mf">3.61783279369958e-1</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.25884806151064e-3</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span>
      <span class="o">+</span><span class="mf">2.06438412905916e-3</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.17699042180559e-5</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span>
      <span class="c1"># Neptune.</span>
      <span class="o">-</span><span class="mf">3.01777243405203e+1</span><span class="p">,</span> <span class="o">+</span><span class="mf">1.91155314998064e+0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.53887595621042e-1</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.17471785045538e-4</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span>
      <span class="o">-</span><span class="mf">3.11361111025884e-3</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span> <span class="o">+</span><span class="mf">3.58344705491441e-5</span> <span class="o">*</span> <span class="mi">365</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>The units of measure are astronomical units, years and Solar masses.</p>
<p>Next, we proceed to the definition of the dynamics via the <code class="docutils literal notranslate"><span class="pre">make_nbody_sys()</span></code> helper:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">heyoka</span> <span class="k">as</span> <span class="nn">hy</span>

<span class="c1"># Create the system of differential equations.</span>
<span class="n">sys</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">make_nbody_sys</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">masses</span> <span class="o">=</span> <span class="n">masses</span><span class="p">,</span> <span class="n">Gconst</span> <span class="o">=</span> <span class="n">G</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In this setup we are expecting close encounters between the planets. In order to build a history of close encounters we will be tracking how the distance between pairs of planets evolves over time.</p>
<p>The square of the distance between planets <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span> is</p>
<div class="math notranslate nohighlight">
\[
D_{ij}\left( t \right) = \left[ x_i\left( t \right) - x_j\left( t \right) \right]^2 + \left[ y_i\left( t \right) - y_j\left( t \right) \right]^2 + \left[ z_i\left( t \right) - z_j\left( t \right) \right]^2,
\]</div>
<p>and its time derivative is</p>
<div class="math notranslate nohighlight">
\[
\frac{dD_{ij}\left( t \right)}{dt} = 2\left[ x_i\left( t \right) - x_j\left( t \right) \right]\left[ v_{xi}\left( t \right) - v_{xj}\left( t \right) \right] +
2\left[ y_i\left( t \right) - y_j\left( t \right) \right]\left[ v_{yi}\left( t \right) - v_{yj}\left( t \right) \right] +
2\left[ z_i\left( t \right) - z_j\left( t \right) \right]\left[ v_{zi}\left( t \right) - v_{zj}\left( t \right) \right].
\]</div>
<p><span class="math notranslate nohighlight">\(dD_{ij}\left( t \right)/dt\)</span> is zero whenever the distance between planets <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span> reaches a local minimum or maximum. By introducing the event equation</p>
<div class="math notranslate nohighlight">
\[
\frac{dD_{ij}\left( t \right)}{dt} = 0
\]</div>
<p>in heyoka.py’s <a class="reference internal" href="Event%20detection.html"><span class="doc std std-doc">event detection</span></a> system we will thus be able to track how the minima of the planetary distances evolve over time.</p>
<p>Let us begin with the definition of the event callback:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># List of minima for the mutual</span>
<span class="c1"># planetary distances.</span>
<span class="n">ce_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># The event callback.</span>
<span class="k">class</span> <span class="nc">ce_cb</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">j</span> <span class="o">=</span> <span class="n">j</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ta</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">d_sgn</span><span class="p">):</span>
        <span class="c1"># Compute the state of the system</span>
        <span class="c1"># at the point of minimum distance.</span>
        <span class="c1"># between planets i and j.</span>
        <span class="n">ta</span><span class="o">.</span><span class="n">update_d_output</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        
        <span class="c1"># Extract the position vectors</span>
        <span class="c1"># for planets i and j.</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">d_output</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">rj</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

        <span class="c1"># Append to ce_list:</span>
        <span class="c1"># - the time at which the minimum is reached,</span>
        <span class="c1"># - the indices of the planets,</span>
        <span class="c1"># - the distance between the planets.</span>
        <span class="n">ce_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ri</span> <span class="o">-</span> <span class="n">rj</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>The event callback will log into the global variable <code class="docutils literal notranslate"><span class="pre">ce_list</span></code> various information about the state of the system when a distance minimum is detected.</p>
<p>Next, we can proceed to the definition of the events:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The list of events.</span>
<span class="n">evs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Iterate over all the planet-planet pairs.</span>
<span class="c1"># NOTE: the planets have indices 1-4 in the ODE</span>
<span class="c1"># system, index 0 is the Sun.</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
    <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">zi</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">make_vars</span><span class="p">(</span><span class="s2">&quot;x_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s2">&quot;y_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s2">&quot;z_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">vxi</span><span class="p">,</span> <span class="n">vyi</span><span class="p">,</span> <span class="n">vzi</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">make_vars</span><span class="p">(</span><span class="s2">&quot;vx_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s2">&quot;vy_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s2">&quot;vz_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
        <span class="n">xj</span><span class="p">,</span> <span class="n">yj</span><span class="p">,</span> <span class="n">zj</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">make_vars</span><span class="p">(</span><span class="s2">&quot;x_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s2">&quot;y_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s2">&quot;z_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
        <span class="n">vxj</span><span class="p">,</span> <span class="n">vyj</span><span class="p">,</span> <span class="n">vzj</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">make_vars</span><span class="p">(</span><span class="s2">&quot;vx_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s2">&quot;vy_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s2">&quot;vz_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
        
        <span class="c1"># The event equation.</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="p">(</span><span class="n">xi</span><span class="o">-</span><span class="n">xj</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">vxi</span><span class="o">-</span><span class="n">vxj</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">yi</span><span class="o">-</span><span class="n">yj</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">vyi</span><span class="o">-</span><span class="n">vyj</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">zi</span><span class="o">-</span><span class="n">zj</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">vzi</span><span class="o">-</span><span class="n">vzj</span><span class="p">)</span>
        
        <span class="c1"># Create the event and append it to</span>
        <span class="c1"># the event list.</span>
        <span class="n">evs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hy</span><span class="o">.</span><span class="n">nt_event</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">ce_cb</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">event_direction</span><span class="o">.</span><span class="n">positive</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Note how we specified a <em>positive</em> direction for the events. This means that the event is detected only when the value of <span class="math notranslate nohighlight">\({dD_{ij}\left( t \right)}/{dt}\)</span> switches from negative to positive (and not viceversa). In other words, by specifying a positive event direction we will be filtering out the maxima of <span class="math notranslate nohighlight">\(D_{ij}\left( t \right)\)</span>, retaining only the minima.</p>
<p>We are now ready to create the integrator object:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ta</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">taylor_adaptive</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">high_accuracy</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-18</span><span class="p">,</span>
                        <span class="c1"># The list of non-terminal events.</span>
                        <span class="n">nt_events</span> <span class="o">=</span> <span class="n">evs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Before proceeding with the integration, it is convenient the recentre the centre of mass in the origin with zero velocity, so that the bodies do not drift during the integration:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reshape for ease of indexing.</span>
<span class="n">st</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

<span class="c1"># Compute the position of the COM.</span>
<span class="n">com_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">st</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">masses</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span>
<span class="n">com_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">st</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">masses</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span>
<span class="n">com_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">st</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">masses</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span>

<span class="c1"># Compute the velocity of the COM.</span>
<span class="n">com_vx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">st</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">masses</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span>
<span class="n">com_vy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">st</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">masses</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span>
<span class="n">com_vz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">st</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">masses</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span>

<span class="c1"># Recentre.</span>
<span class="n">st</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">com_x</span>
<span class="n">st</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">com_y</span>
<span class="n">st</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">com_z</span>
<span class="n">st</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-=</span> <span class="n">com_vx</span>
<span class="n">st</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">-=</span> <span class="n">com_vy</span>
<span class="n">st</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">-=</span> <span class="n">com_vz</span>
</pre></div>
</div>
</div>
</div>
<p>Let us proceed to the numerical integration:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Integrate over a regular time grid</span>
<span class="c1"># up to 1000 years.</span>
<span class="n">final_t</span> <span class="o">=</span> <span class="mf">1000.</span>
<span class="n">t_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">final_t</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="c1"># Integrate</span>
<span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">propagate_grid</span><span class="p">(</span><span class="n">t_grid</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can now visualise the results. We will be plotting the evolution in time of the minima of the planet-planet distances:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">js_ce</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ce_list</span><span class="p">))</span>
<span class="n">ju_ce</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ce_list</span><span class="p">))</span>
<span class="n">jn_ce</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ce_list</span><span class="p">))</span>

<span class="n">su_ce</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ce_list</span><span class="p">))</span>
<span class="n">sn_ce</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ce_list</span><span class="p">))</span>

<span class="n">un_ce</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ce_list</span><span class="p">))</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">from</span> <span class="nn">matplotlib.pylab</span> <span class="kn">import</span> <span class="n">plt</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">js_ce</span><span class="p">],</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">js_ce</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Jupiter-Saturn&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ju_ce</span><span class="p">],</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ju_ce</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Jupiter-Uranus&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">jn_ce</span><span class="p">],</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">jn_ce</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Jupiter-Neptune&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">su_ce</span><span class="p">],</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">su_ce</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Saturn-Uranus&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">sn_ce</span><span class="p">],</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">sn_ce</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Saturn-Neptune&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">un_ce</span><span class="p">],</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">un_ce</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Uranus-Neptune&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$t$ (years)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Distance minimum (AU)&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Scaled outer Solar System_15_0.png" src="../_images/Scaled outer Solar System_15_0.png" />
</div>
</div>
<p>The plot shows how Jupiter and Saturn undergo a few very close encounters (blue line). In particular, at <span class="math notranslate nohighlight">\(t\sim 160\)</span>, the distance minimum is <span class="math notranslate nohighlight">\(\sim 0.01\,\mathrm{AU}\)</span> (less than 6 planetary radiuses, assuming that the inflated planets have the same density as the original ones). This is expected as Jupiter and Saturn are the most massive planets and they occupy adjacent orbits.</p>
<p>Eventually, Saturn and Uranus are ejected from the Solar System, while Neptune remains bound to the Sun with an orbit strongly perturbed by Jupiter. This can be seen by the green line, representing the minimum Jupiter-Neptune distance, which fluctuates periodically.</p>
<p>Note how for some planetary pairs (i.e., brown and red) the lines end before <span class="math notranslate nohighlight">\(t=1000\)</span>. This means that the distance between the planets keeps on growing without ever reaching again a stationary point. For other pairs (e.g., orange and blue), local stationary points remain even after one of the planets in the pair is ejected. This means the orbital velocity of the bound planet is greater than the escape velocity of the unbound planet, and as such the mutual distance, while overall increasing over time, temporarily decreases when the bound planet momentarily “catches up” with the escaped planet.</p>
<p>We are now going to take a look at the evolution of the Heliocentric orbital elements of the planets over time. Let us begin with the semi-major axis first. We will be using <a class="reference external" href="https://esa.github.io/pykep/">pykep</a> for the conversion between Cartesian coordinates and Keplerian elements:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert the planets&#39; Cartesian states</span>
<span class="c1"># into sets of orbital elements.</span>
<span class="k">def</span> <span class="nf">st2kep</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">pykep</span> <span class="k">as</span> <span class="nn">pk</span>
    
    <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">r0</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">vi</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        
        <span class="c1"># NOTE: orbital elements computed</span>
        <span class="c1"># with respect to the Sun.</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">ri</span> <span class="o">-</span> <span class="n">r0</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">vi</span> <span class="o">-</span> <span class="n">v0</span>
        
        <span class="n">mu</span> <span class="o">=</span> <span class="n">G</span><span class="o">*</span><span class="p">(</span><span class="n">masses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">masses</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        
        <span class="n">kep</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">ic2par</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">mu</span><span class="p">))</span>
        
        <span class="c1"># NOTE: transform the Gudermannian into</span>
        <span class="c1"># hyperbolic semi-major axis for unbound</span>
        <span class="c1"># orbits.</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">/</span><span class="n">mu</span><span class="p">)</span>
        <span class="n">kep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
        
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kep</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">out</span>

<span class="n">out_kep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">st2kep</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">out</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">plot_kep</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">,</span> <span class="n">out_kep</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$t$ (years)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Jupiter&quot;</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">,</span> <span class="n">out_kep</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">idx</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$t$ (years)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Saturn&quot;</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">,</span> <span class="n">out_kep</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">idx</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$t$ (years)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Uranus&quot;</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">,</span> <span class="n">out_kep</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">idx</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$t$ (years)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Neptune&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plot_kep</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$a\,\left(\mathrm</span><span class="si">{AU}</span><span class="s2">\right)$&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Scaled outer Solar System_17_0.png" src="../_images/Scaled outer Solar System_17_0.png" />
</div>
</div>
<p>The plots indeed confirm that Saturn and Uranus are ejected (i.e., the semi-major axes become negative). After the ejection of Saturn and Uranus, Jupiter settles in a stable quasi-Keplerian orbit, while Neptune ends up in an outer orbit perturbed by Jupiter. Note how the wide oscillations in semi-major axis for Neptune are due to the strong perturbation of Jupiter onto the Sun, which induces short-term oscillations in the Heliocentric orbital elements of the other planets.</p>
<p>Let us take a look at the eccentricities:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_kep</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;$e$&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Scaled outer Solar System_19_0.png" src="../_images/Scaled outer Solar System_19_0.png" />
</div>
</div>
<p>The eccentricities portray the same picture: after a turbulent and chaotic initial peroid, Saturn and Uranus are ejected (<span class="math notranslate nohighlight">\(e &gt; 1\)</span>) and Jupiter settles into a medium-eccentricity quasi-Keplerian orbit. Like in the previous plot, the rapid variations in the eccentricities of Saturn, Uranus and Neptune for <span class="math notranslate nohighlight">\(t \gtrsim 400\)</span> are due to the strong perturbation of Jupiter onto the Sun.</p>
<p>Let us now zoom into the first close encounter between Jupiter and Saturn at <span class="math notranslate nohighlight">\(t\sim 163\)</span>. First, we create a new integrator taking as initial conditions the state of the system at <span class="math notranslate nohighlight">\(t=163\)</span> and disabling any form of event detection (as we do not need it any more):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ta_ce</span> <span class="o">=</span> <span class="n">hy</span><span class="o">.</span><span class="n">taylor_adaptive</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="mi">163</span><span class="p">],</span> <span class="n">high_accuracy</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-18</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we define a new time grid and we integrate over it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Integrate for 1 year.</span>
<span class="n">t_grid_ce</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>

<span class="c1"># NOTE: min/max_h are the min/max timesteps</span>
<span class="c1"># selected by the integrator.</span>
<span class="n">_</span><span class="p">,</span> <span class="n">min_h</span><span class="p">,</span> <span class="n">max_h</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">out_ce</span> <span class="o">=</span> <span class="n">ta_ce</span><span class="o">.</span><span class="n">propagate_grid</span><span class="p">(</span><span class="n">t_grid_ce</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let us now plot the close encounter:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">out_ce</span> <span class="o">=</span> <span class="n">out_ce</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">out_ce</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">out_ce</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Jupiter&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">out_ce</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">out_ce</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Saturn&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mf">4.38</span><span class="p">,</span> <span class="mf">4.44</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="o">-</span><span class="mf">2.20</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.15</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$y$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Scaled outer Solar System_25_0.png" src="../_images/Scaled outer Solar System_25_0.png" />
</div>
</div>
<p>We can see how Jupiter’s motion becomes temporarily retrograde during the encounter with Saturn.</p>
<p>Note how the integrator automatically decreased the timestep size in correspondence of the close encounter:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Min. timestep: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_h</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Max. timestep: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_h</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Min. timestep: 0.00013865629022107346
Max. timestep: 0.124164535505792
</pre></div>
</div>
</div>
</div>
</div>


              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="Inverting%20Kepler%27s%20equation%20in%20ODEs.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Inverting Kepler’s equation in ODEs</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="Planetary%20embryos.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Planetary embryos in the inner Solar System</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Francesco Biscani and Dario Izzo<br/>
        
            &copy; Copyright 2020, 2021, Francesco Biscani and Dario Izzo.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>